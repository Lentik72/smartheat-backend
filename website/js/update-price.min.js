let supplierData=null,token=null;const loadingState=document.getElementById("loading-state"),errorState=document.getElementById("error-state"),updateInterface=document.getElementById("update-interface"),successState=document.getElementById("success-state"),priceForm=document.getElementById("price-update-form");document.addEventListener("DOMContentLoaded",init);async function init(){if(token=new URLSearchParams(window.location.search).get("token"),!token){showError("No access token provided. Please use the link from your email.");return}try{sessionStorage.setItem("supplier_token",token),window.history.replaceState({},document.title,"/update-price.html")}catch(e){}await validateToken()}async function validateToken(){try{const t=await fetch(`/api/supplier-update?token=${encodeURIComponent(token)}`),e=await t.json();if(!t.ok||!e.success){showError(e.error||"Invalid or expired link.");return}supplierData=e.supplier,renderSupplierInfo(e),showUpdateInterface()}catch(t){console.error("Validation error:",t),showError("Could not validate your link. Please try again later.")}}function renderSupplierInfo(t){const{supplier:e,priceHistory:a}=t;document.getElementById("supplier-name").textContent=e.name,document.getElementById("supplier-location").textContent=`${e.city}, ${e.state}`,e.viewsLast7Days>0&&(document.getElementById("view-count").textContent=e.viewsLast7Days,document.getElementById("engagement-card").style.display="block");const r=document.getElementById("current-price-display");if(e.currentPrice){const s=e.lastUpdated?new Date(e.lastUpdated).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"Unknown";r.innerHTML=`
            <div class="price">$${e.currentPrice.toFixed(3)}</div>
            <div class="price-details">
                Min ${e.currentMinGallons||100} gallons \xB7 Updated ${s}
            </div>
        `,document.getElementById("new-price").value=e.currentPrice.toFixed(3),e.currentMinGallons&&(document.getElementById("min-gallons").value=e.currentMinGallons)}if(a&&a.length>1){const s=document.getElementById("price-history-list");s.innerHTML=a.slice(0,5).map(n=>{const o=new Date(n.date).toLocaleDateString("en-US",{month:"short",day:"numeric"}),i=getSourceLabel(n.source);return`
                <div class="price-history-item">
                    <span class="price">$${n.price.toFixed(3)}</span>
                    <span>
                        <span class="date">${o}</span>
                        <span class="source">${i}</span>
                    </span>
                </div>
            `}).join(""),document.getElementById("price-history").style.display="block"}}function getSourceLabel(t){return{supplier_direct:"You",web_scrape:"Auto",manual:"Admin",api:"API"}[t]||""}priceForm.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("submit-btn");e.disabled=!0,e.textContent="Updating...";const a=parseFloat(document.getElementById("new-price").value),r=parseInt(document.getElementById("min-gallons").value),s=document.getElementById("notes").value.trim();if(isNaN(a)||a<1.5||a>6){alert("Price must be between $1.50 and $6.00"),e.disabled=!1,e.textContent="Update Price";return}try{const n=await fetch("/api/supplier-update/price",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token,price:a,minGallons:r,notes:s})}),o=await n.json();if(!n.ok||!o.success)throw new Error(o.error||"Failed to update price");document.getElementById("updated-price").textContent=`$${o.price.toFixed(2)}/gal`,showSuccessState()}catch(n){console.error("Update error:",n),alert(n.message||"Failed to update price. Please try again."),e.disabled=!1,e.textContent="Update Price"}});function showError(t){loadingState.style.display="none",updateInterface.style.display="none",successState.style.display="none",document.getElementById("error-message").textContent=t,errorState.style.display="block"}function showUpdateInterface(){loadingState.style.display="none",errorState.style.display="none",successState.style.display="none",updateInterface.style.display="block"}function showSuccessState(){loadingState.style.display="none",errorState.style.display="none",updateInterface.style.display="none",successState.style.display="block"}function showUpdateForm(){document.getElementById("submit-btn").disabled=!1,document.getElementById("submit-btn").textContent="Update Price",validateToken()}document.getElementById("update-again-btn").addEventListener("click",showUpdateForm);
