<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartHeat Analytics Dashboard</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="stylesheet" href="dashboard.css?v=1770245437">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <!-- Login Modal -->
  <div id="login-modal" class="modal">
    <div class="modal-content">
      <h2>Dashboard Login</h2>
      <form id="login-form">
        <input type="password" id="password" placeholder="Password" required autofocus>
        <button type="submit">Login</button>
        <p id="login-error" class="error"></p>
      </form>
    </div>
  </div>

  <!-- Mobile sidebar overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  <!-- Main Dashboard with App Layout -->
  <div id="dashboard" class="hidden app-layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <span class="sidebar-logo-icon">üî•</span>
          <span>SmartHeat</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <!-- Main Navigation -->
        <div class="nav-section">
          <button class="nav-item active" data-tab="leaderboard">
            <span class="nav-item-icon">üèÜ</span>
            <span class="nav-item-label">Leaderboard</span>
          </button>
          <button class="nav-item" data-tab="app-analytics">
            <span class="nav-item-icon">üìä</span>
            <span class="nav-item-label">App Analytics</span>
          </button>
          <button class="nav-item" data-tab="retention">
            <span class="nav-item-icon">üîÑ</span>
            <span class="nav-item-label">Retention</span>
          </button>
          <button class="nav-item" data-tab="growth">
            <span class="nav-item-icon">üìà</span>
            <span class="nav-item-label">Growth</span>
          </button>
          <button class="nav-item" data-tab="coverage">
            <span class="nav-item-icon">üó∫Ô∏è</span>
            <span class="nav-item-label">Coverage</span>
          </button>
          <button class="nav-item" data-tab="suppliers">
            <span class="nav-item-icon">üè¢</span>
            <span class="nav-item-label">Suppliers</span>
          </button>
          <button class="nav-item" data-tab="settings">
            <span class="nav-item-icon">‚öôÔ∏è</span>
            <span class="nav-item-label">Settings</span>
          </button>
        </div>

        <!-- Legacy Section (Collapsed by default) -->
        <div class="nav-section collapsed" id="legacy-nav-section">
          <div class="nav-section-header" id="legacy-toggle">
            <span class="nav-section-title">Legacy Views</span>
            <span class="nav-section-toggle">‚ñº</span>
          </div>
          <div class="nav-items">
            <button class="nav-item" data-tab="overview">
              <span class="nav-item-icon">üìã</span>
              <span class="nav-item-label">Overview</span>
            </button>
            <button class="nav-item" data-tab="website">
              <span class="nav-item-icon">üåê</span>
              <span class="nav-item-label">Website</span>
            </button>
            <button class="nav-item" data-tab="searches">
              <span class="nav-item-icon">üîç</span>
              <span class="nav-item-label">Searches</span>
            </button>
            <button class="nav-item" data-tab="clicks">
              <span class="nav-item-icon">üëÜ</span>
              <span class="nav-item-label">Clicks</span>
            </button>
            <button class="nav-item" data-tab="prices">
              <span class="nav-item-icon">üí∞</span>
              <span class="nav-item-label">Prices</span>
            </button>
            <button class="nav-item" data-tab="ios-app">
              <span class="nav-item-icon">üì±</span>
              <span class="nav-item-label">iOS App</span>
            </button>
            <button class="nav-item" data-tab="map">
              <span class="nav-item-icon">üìç</span>
              <span class="nav-item-label">Map</span>
            </button>
          </div>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="period-selector">
          <button class="period-btn" data-days="7">7d</button>
          <button class="period-btn active" data-days="30">30d</button>
          <button class="period-btn" data-days="90">90d</button>
        </div>
      </div>
    </aside>

    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Sticky Header -->
      <div class="sticky-header">
        <div class="sticky-header-content">
          <div class="sticky-header-left">
            <button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
            <h1 class="page-title" id="page-title">Leaderboard</h1>
          </div>
          <div class="header-metrics">
            <div class="header-metric">
              <span class="header-metric-value" id="header-users">--</span>
              <span class="header-metric-label">Users</span>
            </div>
            <div class="header-metric">
              <span class="header-metric-value" id="header-revenue">--</span>
              <span class="header-metric-label">Revenue</span>
            </div>
            <div class="header-metric">
              <span class="header-metric-value" id="header-deliveries">--</span>
              <span class="header-metric-label">Deliveries</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Legacy header (hidden with sidebar) -->
      <header>
        <h1>SmartHeat Intelligence</h1>
        <div class="period-selector">
          <button class="period-btn" data-days="7">7d</button>
          <button class="period-btn active" data-days="30">30d</button>
          <button class="period-btn" data-days="90">90d</button>
        </div>
      </header>

      <!-- Top Priority Alert -->
      <div id="top-priority-alert" class="top-priority hidden">
        <div class="priority-badge">TOP PRIORITY</div>
        <div class="priority-content">
          <div class="priority-title" id="priority-title">Loading...</div>
          <div class="priority-insight" id="priority-insight"></div>
        </div>
        <div class="priority-actions">
          <button class="btn-outline" id="priority-view-details">View Details</button>
        </div>
      </div>

      <!-- Data Source Status Banner -->
      <div id="data-source-warnings" class="data-source-banner hidden">
        <div class="banner-content">
          <span class="banner-icon">‚ö†Ô∏è</span>
          <span class="banner-text" id="data-source-text">Analytics services not connected</span>
          <div class="banner-details" id="data-source-details"></div>
        </div>
        <button class="banner-dismiss" id="dismiss-banner">√ó</button>
      </div>

      <!-- Summary Cards (Combined Business Metrics) -->
      <div class="cards">
        <div class="card" id="card-users">
          <div class="card-label">Total Users</div>
          <div class="card-value" id="total-users">--</div>
          <div class="card-sub" id="users-breakdown">-- iOS / -- website</div>
          <div class="card-freshness" id="users-freshness">--</div>
        </div>
        <div class="card" id="card-deliveries">
          <div class="card-label">Deliveries Logged</div>
          <div class="card-value" id="total-deliveries">--</div>
          <div class="card-sub" id="deliveries-breakdown">Real orders tracked</div>
          <div class="card-freshness" id="deliveries-freshness">--</div>
        </div>
        <div class="card" id="card-revenue">
          <div class="card-label">Est. Revenue</div>
          <div class="card-value" id="est-revenue">--</div>
          <div class="card-sub" id="revenue-breakdown">From supplier clicks</div>
          <div class="card-freshness" id="revenue-freshness">--</div>
        </div>
        <div class="card" id="card-android">
          <div class="card-label">Android Waitlist</div>
          <div class="card-value" id="waitlist-total">--</div>
          <div class="card-sub" id="waitlist-recent">+-- this week</div>
          <div class="card-freshness" id="waitlist-freshness">--</div>
        </div>
      </div>

      <!-- Alert Banner -->
      <div id="alert-banner" class="alert hidden">
        <span id="alert-text"></span>
        <a href="#" id="alert-action">View</a>
      </div>

      <!-- Legacy Tabs (hidden with sidebar nav) -->
      <nav class="tabs">
        <button class="tab active" data-tab="leaderboard">üèÜ Leaderboard</button>
        <button class="tab" data-tab="app-analytics">üìä App Analytics</button>
        <button class="tab" data-tab="retention">üîÑ Retention</button>
        <button class="tab" data-tab="growth">üìà Growth</button>
        <button class="tab" data-tab="coverage">üó∫Ô∏è Coverage</button>
        <button class="tab" data-tab="settings">‚öôÔ∏è Settings</button>
      </nav>

    <!-- Tab Content -->
    <main class="tab-content">

      <!-- ============================================================ -->
      <!-- LEADERBOARD TAB (Default) - Scope 18 -->
      <!-- ============================================================ -->
      <section id="tab-leaderboard" class="tab-panel active">
        <div class="leaderboard-container">
          <div id="leaderboard-loading" class="loading">Loading supplier rankings...</div>

          <div id="leaderboard-content" class="hidden">
            <!-- Quick Wins Panel -->
            <div class="quick-wins-panel" id="quick-wins-panel">
              <h3>üí° Quick Wins</h3>
              <div id="quick-wins-list"></div>
            </div>

            <!-- Summary Stats -->
            <div class="leaderboard-summary">
              <div class="summary-stat">
                <span class="summary-value" id="lb-total-suppliers">--</span>
                <span class="summary-label">Suppliers</span>
              </div>
              <div class="summary-stat">
                <span class="summary-value" id="lb-total-clicks">--</span>
                <span class="summary-label">Total Clicks</span>
              </div>
              <div class="summary-stat">
                <span class="summary-value" id="lb-market-avg">--</span>
                <span class="summary-label">Market Avg</span>
              </div>
              <div class="summary-stat">
                <span class="summary-value" id="lb-top3-pct">--</span>
                <span class="summary-label">Top 3 Share</span>
              </div>
            </div>

            <!-- Consolidated Leaderboard Table -->
            <div class="panel full-width">
              <div class="panel-header">
                <h3>üèÜ Supplier Leaderboard</h3>
                <div class="header-actions">
                  <span class="data-source-badge" id="lb-data-source">Web + App</span>
                  <button id="lb-export-csv" class="btn-small">Export CSV</button>
                </div>
              </div>
              <table id="leaderboard-table" class="leaderboard-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Supplier</th>
                    <th>Location</th>
                    <th>üë• Users</th>
                    <th>üìû Calls</th>
                    <th>üîó Site</th>
                    <th>Total</th>
                    <th>üåê Web</th>
                    <th>üì± App</th>
                    <th>Price</th>
                    <th>vs Mkt</th>
                    <th>Signal</th>
                  </tr>
                </thead>
                <tbody id="leaderboard-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- ============================================================ -->
      <!-- APP ANALYTICS TAB - Scope 18 -->
      <!-- ============================================================ -->
      <section id="tab-app-analytics" class="tab-panel">
        <div class="app-analytics-container">
          <div id="app-analytics-loading" class="loading">Loading app analytics...</div>

          <!-- Data Source Indicator -->
          <div id="app-data-source" class="data-source-indicator hidden">
            <span class="source-badge bigquery">üìä BigQuery</span>
            <span class="source-text">Real-time Firebase Analytics data</span>
          </div>

          <div id="app-analytics-content" class="hidden">
            <!-- iOS App Summary Cards -->
            <div class="cards">
              <div class="card">
                <div class="card-label">Unique Users</div>
                <div class="card-value" id="aa-users">--</div>
                <div class="card-sub" id="aa-users-sub">--</div>
              </div>
              <div class="card">
                <div class="card-label">Total Sessions</div>
                <div class="card-value" id="aa-sessions">--</div>
                <div class="card-sub" id="aa-sessions-sub">--</div>
              </div>
              <div class="card">
                <div class="card-label">Day 1 Retention</div>
                <div class="card-value" id="aa-day1">--%</div>
                <div class="card-sub" id="aa-day1-sub">-- retained</div>
              </div>
              <div class="card">
                <div class="card-label">Day 7 Retention</div>
                <div class="card-value" id="aa-day7">--%</div>
                <div class="card-sub" id="aa-day7-sub">-- retained</div>
              </div>
            </div>

            <!-- Daily Active Users Chart -->
            <div class="panel full-width">
              <h3>üìà Daily Active Users</h3>
              <div class="dau-chart-container">
                <canvas id="dau-chart"></canvas>
              </div>
              <div class="chart-stats">
                <span>Avg Daily: <strong id="dau-avg">--</strong></span>
                <span>Peak: <strong id="dau-peak">--</strong></span>
              </div>
            </div>

            <!-- Onboarding Funnel -->
            <div class="panel full-width">
              <h3>üöÄ Onboarding Funnel</h3>
              <div class="funnel-container" id="onboarding-funnel">
                <div class="funnel-step">
                  <span class="funnel-name">Install</span>
                  <div class="funnel-bar-container">
                    <div class="funnel-bar" id="funnel-install" style="width: 100%"></div>
                  </div>
                  <span class="funnel-count" id="funnel-install-count">--</span>
                  <span class="funnel-pct" id="funnel-install-pct">100%</span>
                </div>
                <div class="funnel-step">
                  <span class="funnel-name">Start Onboarding</span>
                  <div class="funnel-bar-container">
                    <div class="funnel-bar" id="funnel-onboard" style="width: 0%"></div>
                  </div>
                  <span class="funnel-count" id="funnel-onboard-count">--</span>
                  <span class="funnel-pct" id="funnel-onboard-pct">--%</span>
                </div>
                <div class="funnel-step">
                  <span class="funnel-name">Complete Onboarding</span>
                  <div class="funnel-bar-container">
                    <div class="funnel-bar" id="funnel-complete" style="width: 0%"></div>
                  </div>
                  <span class="funnel-count" id="funnel-complete-count">--</span>
                  <span class="funnel-pct" id="funnel-complete-pct">--%</span>
                </div>
                <div class="funnel-step">
                  <span class="funnel-name">First Value Action</span>
                  <div class="funnel-bar-container">
                    <div class="funnel-bar activated" id="funnel-fva" style="width: 0%"></div>
                  </div>
                  <span class="funnel-count" id="funnel-fva-count">--</span>
                  <span class="funnel-pct" id="funnel-fva-pct">--%</span>
                </div>
              </div>
              <div class="funnel-insight" id="funnel-insight">
                üí° Track user activation from install to first meaningful action
              </div>
            </div>

            <!-- Two Column: Top Events & Top Screens -->
            <div class="panel-grid two-col">
              <div class="panel">
                <h3>üéØ Top Events</h3>
                <table class="mini-table" id="top-events-table">
                  <thead>
                    <tr>
                      <th>Event</th>
                      <th>Count</th>
                      <th>Users</th>
                    </tr>
                  </thead>
                  <tbody id="top-events-body"></tbody>
                </table>
              </div>
              <div class="panel">
                <h3>üì± Top Screens</h3>
                <table class="mini-table" id="top-screens-table">
                  <thead>
                    <tr>
                      <th>Screen</th>
                      <th>Views</th>
                      <th>Users</th>
                    </tr>
                  </thead>
                  <tbody id="top-screens-body"></tbody>
                </table>
              </div>
            </div>

            <!-- Legacy Engagement Section (hidden when BigQuery available) -->
            <div id="legacy-engagement" class="hidden">
            <!-- Engagement Summary Cards -->
            <div class="cards">
              <div class="card">
                <div class="card-label">Power Users</div>
                <div class="card-value" id="aa-power">--%</div>
                <div class="card-sub">6+ actions/session</div>
              </div>
              <div class="card">
                <div class="card-label">Engaged</div>
                <div class="card-value" id="aa-engaged">--%</div>
                <div class="card-sub">3-5 actions/session</div>
              </div>
              <div class="card">
                <div class="card-label">At Risk</div>
                <div class="card-value" id="aa-browse">--%</div>
                <div class="card-sub">Browse only</div>
              </div>
            </div>

            <!-- Engagement Breakdown -->
            <div class="panel full-width">
              <h3>Engagement Breakdown</h3>
              <div class="engagement-bars" id="engagement-bars">
                <div class="engagement-bar-row">
                  <span class="bar-label">Power Users</span>
                  <div class="bar-container"><div class="bar power" id="bar-power"></div></div>
                  <span class="bar-value" id="bar-power-val">--%</span>
                </div>
                <div class="engagement-bar-row">
                  <span class="bar-label">Engaged</span>
                  <div class="bar-container"><div class="bar engaged" id="bar-engaged"></div></div>
                  <span class="bar-value" id="bar-engaged-val">--%</span>
                </div>
                <div class="engagement-bar-row">
                  <span class="bar-label">Casual</span>
                  <div class="bar-container"><div class="bar casual" id="bar-casual"></div></div>
                  <span class="bar-value" id="bar-casual-val">--%</span>
                </div>
                <div class="engagement-bar-row">
                  <span class="bar-label">Browse Only</span>
                  <div class="bar-container"><div class="bar browse" id="bar-browse"></div></div>
                  <span class="bar-value" id="bar-browse-val">--%</span>
                </div>
              </div>
            </div>
            </div><!-- End legacy-engagement -->

            <!-- Two Column Layout -->
            <div class="panel-grid two-col">
              <!-- Delivery Patterns -->
              <div class="panel">
                <h3>üì¶ Delivery Patterns</h3>
                <div id="delivery-patterns">
                  <div class="stat-row">
                    <span>Total Deliveries</span>
                    <span class="stat-value" id="dp-total">--</span>
                  </div>
                  <div class="stat-row">
                    <span>Est. Order Value</span>
                    <span class="stat-value" id="dp-value">--</span>
                  </div>
                  <div class="stat-row highlight">
                    <span>Repeat Supplier Rate</span>
                    <span class="stat-value" id="dp-repeat">--%</span>
                  </div>
                  <div class="stat-row highlight">
                    <span>From Directory</span>
                    <span class="stat-value" id="dp-directory">--%</span>
                  </div>
                  <hr>
                  <div class="stat-row">
                    <span>Ordered On-Time</span>
                    <span class="stat-value" id="dp-ontime">--%</span>
                  </div>
                  <div class="stat-row">
                    <span>Ordered Late</span>
                    <span class="stat-value" id="dp-late">--%</span>
                  </div>
                  <div class="stat-row warning">
                    <span>Overdue (ran out?)</span>
                    <span class="stat-value" id="dp-overdue">--</span>
                  </div>
                </div>
                <div class="insight-box" id="dp-insight"></div>
              </div>

              <!-- FVE (First Value Event) -->
              <div class="panel">
                <h3>üéØ First Value Event</h3>
                <div id="fve-stats">
                  <div class="stat-row">
                    <span>FVE Completion Rate</span>
                    <span class="stat-value" id="fve-rate">--%</span>
                  </div>
                  <div class="stat-row">
                    <span>Within 72 Hours</span>
                    <span class="stat-value" id="fve-72h">--%</span>
                  </div>
                  <hr>
                  <div class="stat-row highlight">
                    <span>FVE User Retention</span>
                    <span class="stat-value" id="fve-retention">--%</span>
                  </div>
                  <div class="stat-row">
                    <span>Non-FVE Retention</span>
                    <span class="stat-value" id="fve-non-retention">--%</span>
                  </div>
                  <div class="stat-row highlight">
                    <span>Retention Multiplier</span>
                    <span class="stat-value" id="fve-multiplier">--√ó</span>
                  </div>
                </div>
                <div class="insight-box" id="fve-insight"></div>
              </div>
            </div>

            <!-- Confidence Score -->
            <div class="panel full-width">
              <h3>üõ°Ô∏è User Confidence Score</h3>
              <div class="confidence-container">
                <div class="confidence-summary">
                  <div class="confidence-score-display">
                    <span class="score-value" id="cs-avg">--</span>
                    <span class="score-label">Avg Score</span>
                  </div>
                  <div class="confidence-distribution">
                    <div class="dist-bar high" id="cs-high-bar"></div>
                    <div class="dist-bar medium" id="cs-med-bar"></div>
                    <div class="dist-bar low" id="cs-low-bar"></div>
                  </div>
                  <div class="confidence-legend">
                    <span><span class="dot high"></span> High (<span id="cs-high-pct">--%</span>)</span>
                    <span><span class="dot medium"></span> Medium (<span id="cs-med-pct">--%</span>)</span>
                    <span><span class="dot low"></span> Low (<span id="cs-low-pct">--%</span>)</span>
                  </div>
                </div>
                <div class="confidence-factors" id="confidence-factors">
                  <!-- Filled by JS -->
                </div>
              </div>
              <div class="insight-box" id="cs-insight"></div>
            </div>

            <!-- Fuel Type Breakdown -->
            <div class="panel full-width">
              <h3>‚õΩ Fuel Type Breakdown</h3>
              <div class="fuel-comparison">
                <div class="fuel-card oil">
                  <div class="fuel-icon">üõ¢Ô∏è</div>
                  <div class="fuel-name">Heating Oil</div>
                  <div class="fuel-users" id="fuel-oil-users">-- users</div>
                  <div class="fuel-pct" id="fuel-oil-pct">--%</div>
                  <div class="fuel-status">‚úÖ Served</div>
                </div>
                <div class="fuel-card propane">
                  <div class="fuel-icon">üî•</div>
                  <div class="fuel-name">Propane</div>
                  <div class="fuel-users" id="fuel-propane-users">-- users</div>
                  <div class="fuel-pct" id="fuel-propane-pct">--%</div>
                  <div class="fuel-status" id="fuel-propane-status">‚ö†Ô∏è Underserved</div>
                </div>
              </div>
              <div class="propane-signals" id="propane-signals">
                <h4>Propane Demand Signals</h4>
                <div id="propane-signal-list"></div>
              </div>
            </div>

            <!-- Correlation Analysis -->
            <div class="panel-grid two-col">
              <!-- Price vs Clicks Correlation -->
              <div class="panel">
                <h3>üí∞ Price vs Engagement</h3>
                <div class="correlation-summary" id="price-correlation">
                  <div class="correlation-value">
                    <span class="corr-number" id="price-corr-value">--</span>
                    <span class="corr-label">Correlation</span>
                  </div>
                  <div class="correlation-scale">
                    <div class="scale-bar">
                      <div class="scale-marker" id="price-corr-marker"></div>
                    </div>
                    <div class="scale-labels">
                      <span>-1 (inverse)</span>
                      <span>0</span>
                      <span>+1 (direct)</span>
                    </div>
                  </div>
                </div>
                <div class="insight-box" id="price-corr-insight">Loading...</div>
              </div>

              <!-- Weather vs Clicks Correlation -->
              <div class="panel">
                <h3>üå°Ô∏è Weather Impact</h3>
                <div class="weather-summary" id="weather-correlation">
                  <div class="weather-current">
                    <span class="weather-temp" id="weather-temp">--¬∞F</span>
                    <span class="weather-conditions" id="weather-conditions">--</span>
                  </div>
                </div>
                <div class="insight-box" id="weather-insight">Loading...</div>
              </div>
            </div>

            <!-- Price, Clicks & Weather Chart -->
            <div class="panel full-width">
              <h3>üìä Price, Weather & Engagement Trends</h3>
              <p class="panel-hint">Visualize how price and temperature affect user engagement over time</p>
              <div class="correlation-chart-container">
                <canvas id="correlation-chart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ============================================================ -->
      <!-- GROWTH TAB - Scope 18 (Merged iOS + Android + Website) -->
      <!-- ============================================================ -->
      <section id="tab-growth" class="tab-panel">
        <div class="growth-container">
          <div id="growth-loading" class="loading">Loading growth metrics...</div>

          <div id="growth-content" class="hidden">
            <!-- Platform Comparison -->
            <div class="panel full-width">
              <h3>üì± Platform Comparison</h3>
              <div class="platform-grid">
                <div class="platform-card ios">
                  <div class="platform-header">
                    <span class="platform-icon">üçé</span>
                    <span class="platform-name">iOS App</span>
                    <span class="platform-status live">LIVE</span>
                  </div>
                  <div class="platform-stats">
                    <div class="p-stat">
                      <span class="p-value" id="p-ios-users">--</span>
                      <span class="p-label">Users</span>
                    </div>
                    <div class="p-stat">
                      <span class="p-value" id="p-ios-deliveries">--</span>
                      <span class="p-label">Deliveries</span>
                    </div>
                    <div class="p-stat">
                      <span class="p-value" id="p-ios-retention">--%</span>
                      <span class="p-label">Week-1 Retention</span>
                    </div>
                  </div>
                </div>

                <div class="platform-card android">
                  <div class="platform-header">
                    <span class="platform-icon">ü§ñ</span>
                    <span class="platform-name">Android</span>
                    <span class="platform-status" id="p-android-status">WAITLIST</span>
                  </div>
                  <div class="platform-stats">
                    <div class="p-stat">
                      <span class="p-value" id="p-android-waitlist">--</span>
                      <span class="p-label">Waitlist</span>
                    </div>
                    <div class="p-stat">
                      <span class="p-value" id="p-android-pwa">--</span>
                      <span class="p-label">PWA Installs</span>
                    </div>
                    <div class="p-stat">
                      <span class="p-value" id="p-android-launches">--</span>
                      <span class="p-label">PWA Launches</span>
                    </div>
                  </div>
                </div>

                <div class="platform-card web">
                  <div class="platform-header">
                    <span class="platform-icon">üåê</span>
                    <span class="platform-name">Website</span>
                    <span class="platform-status live">LIVE</span>
                  </div>
                  <div class="platform-stats">
                    <div class="p-stat">
                      <span class="p-value" id="p-web-visitors">--</span>
                      <span class="p-label">Visitors</span>
                    </div>
                    <div class="p-stat">
                      <span class="p-value" id="p-web-clicks">--</span>
                      <span class="p-label">Clicks</span>
                    </div>
                    <div class="p-stat">
                      <span class="p-value" id="p-web-calls">--</span>
                      <span class="p-label">Calls</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="insight-box" id="platform-insight"></div>
            </div>

            <!-- Android Decision Matrix -->
            <div class="panel full-width">
              <h3>ü§ñ Android Decision Matrix</h3>
              <div class="android-decision">
                <div class="decision-status" id="android-decision-status">
                  <span class="decision-badge" id="android-badge">WAIT</span>
                  <span class="decision-message" id="android-message">Loading...</span>
                </div>
                <div class="decision-conditions">
                  <h4>GO Conditions</h4>
                  <div class="condition" id="cond-waitlist">
                    <span class="cond-check">‚ùì</span>
                    <span class="cond-name">Waitlist ‚â• 200</span>
                    <span class="cond-value">--/200</span>
                  </div>
                  <div class="condition" id="cond-pwa">
                    <span class="cond-check">‚ùì</span>
                    <span class="cond-name">PWA Installs ‚â• 50</span>
                    <span class="cond-value">--/50</span>
                  </div>
                  <div class="condition" id="cond-retention">
                    <span class="cond-check">‚ùì</span>
                    <span class="cond-name">iOS Retention ‚â• 20%</span>
                    <span class="cond-value">--%</span>
                  </div>
                </div>
                <div class="decision-nogo">
                  <h4>NO-GO Conditions</h4>
                  <p class="nogo-text">If iOS retention &lt;20%, fix core product first. Don't scale a leaky bucket.</p>
                </div>
              </div>
            </div>

            <!-- Retention by Action -->
            <div class="panel full-width">
              <h3>üìä Retention by User Action</h3>
              <div class="retention-by-action" id="retention-by-action">
                <div class="retention-bar-row">
                  <span class="rba-label">Logged Delivery</span>
                  <div class="rba-bar-container"><div class="rba-bar" id="rba-delivery"></div></div>
                  <span class="rba-value" id="rba-delivery-val">--%</span>
                </div>
                <div class="retention-bar-row">
                  <span class="rba-label">Set Up Tank</span>
                  <div class="rba-bar-container"><div class="rba-bar" id="rba-tank"></div></div>
                  <span class="rba-value" id="rba-tank-val">--%</span>
                </div>
                <div class="retention-bar-row">
                  <span class="rba-label">Searched Supplier</span>
                  <div class="rba-bar-container"><div class="rba-bar" id="rba-search"></div></div>
                  <span class="rba-value" id="rba-search-val">--%</span>
                </div>
                <div class="retention-bar-row">
                  <span class="rba-label">Just Browsed</span>
                  <div class="rba-bar-container"><div class="rba-bar browse" id="rba-browse"></div></div>
                  <span class="rba-value" id="rba-browse-val">--%</span>
                </div>
              </div>
              <div class="insight-box" id="retention-insight">
                üí° Users who log a delivery retain significantly better. Your #1 goal: Get users to log one delivery.
              </div>
            </div>

            <!-- User Journey Funnel -->
            <div class="panel full-width">
              <h3>üöÄ User Journey</h3>
              <p class="panel-subtitle">Conversion funnel from first visit to delivery</p>

              <div class="uj-container">
                <!-- Web Journey -->
                <div class="uj-section">
                  <div class="uj-header">
                    <span class="uj-icon">üåê</span>
                    <span class="uj-title">Website</span>
                    <span class="uj-conversion" id="wj-overall">--%</span>
                  </div>

                  <div class="uj-steps">
                    <div class="uj-step">
                      <div class="uj-step-num">1</div>
                      <div class="uj-step-content">
                        <div class="uj-step-label">Site Visitors</div>
                        <div class="uj-step-bar-bg">
                          <div class="uj-step-bar" id="wj-visits-bar" style="width: 100%"></div>
                        </div>
                        <div class="uj-step-source">via GA4</div>
                      </div>
                      <div class="uj-step-stats">
                        <span class="uj-step-count" id="wj-visits">--</span>
                        <span class="uj-step-pct">100%</span>
                      </div>
                    </div>

                    <div class="uj-drop"><span class="uj-drop-pct" id="wj-drop-1">--%</span> bounced</div>

                    <div class="uj-step">
                      <div class="uj-step-num">2</div>
                      <div class="uj-step-content">
                        <div class="uj-step-label">Engaged Users</div>
                        <div class="uj-step-bar-bg">
                          <div class="uj-step-bar" id="wj-views-bar" style="width: 50%"></div>
                        </div>
                        <div class="uj-step-source">didn't bounce</div>
                      </div>
                      <div class="uj-step-stats">
                        <span class="uj-step-count" id="wj-views">--</span>
                        <span class="uj-step-pct" id="wj-views-rate">--%</span>
                      </div>
                    </div>

                    <div class="uj-drop"><span class="uj-drop-pct" id="wj-drop-2">--%</span> didn't contact</div>

                    <div class="uj-step">
                      <div class="uj-step-num">3</div>
                      <div class="uj-step-content">
                        <div class="uj-step-label">Contact Supplier</div>
                        <div class="uj-step-bar-bg">
                          <div class="uj-step-bar" id="wj-clicks-bar" style="width: 30%"></div>
                        </div>
                        <div class="uj-step-detail">üìû <span id="wj-calls">--</span> calls ¬∑ üîó <span id="wj-websites">--</span> websites</div>
                      </div>
                      <div class="uj-step-stats">
                        <span class="uj-step-count" id="wj-clicks">--</span>
                        <span class="uj-step-pct" id="wj-clicks-rate">--%</span>
                      </div>
                    </div>

                    <div class="uj-drop"><span class="uj-drop-pct" id="wj-drop-3">--%</span> didn't install</div>

                    <div class="uj-step uj-step-goal">
                      <div class="uj-step-num">‚úì</div>
                      <div class="uj-step-content">
                        <div class="uj-step-label">Install App</div>
                        <div class="uj-step-detail">üì± <span id="wj-ios">--</span> iOS ¬∑ üåê <span id="wj-pwa">--</span> PWA</div>
                        <div class="uj-step-bar-bg">
                          <div class="uj-step-bar uj-bar-success" id="wj-deliveries-bar" style="width: 10%"></div>
                        </div>
                      </div>
                      <div class="uj-step-stats">
                        <span class="uj-step-count" id="wj-deliveries">--</span>
                        <span class="uj-step-pct" id="wj-deliveries-rate">--%</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- App Journey -->
                <div class="uj-section">
                  <div class="uj-header">
                    <span class="uj-icon">üì±</span>
                    <span class="uj-title">iOS App</span>
                    <span class="uj-conversion uj-conv-good" id="aj-overall">--%</span>
                  </div>

                  <div class="uj-steps">
                    <div class="uj-step">
                      <div class="uj-step-num">1</div>
                      <div class="uj-step-content">
                        <div class="uj-step-label">App Opens</div>
                        <div class="uj-step-bar-bg">
                          <div class="uj-step-bar uj-bar-app" id="aj-opens-bar" style="width: 100%"></div>
                        </div>
                      </div>
                      <div class="uj-step-stats">
                        <span class="uj-step-count" id="aj-opens">--</span>
                        <span class="uj-step-pct">100%</span>
                      </div>
                    </div>

                    <div class="uj-drop"><span class="uj-drop-pct" id="aj-drop-1">--%</span> left</div>

                    <div class="uj-step">
                      <div class="uj-step-num">2</div>
                      <div class="uj-step-content">
                        <div class="uj-step-label">Search Directory</div>
                        <div class="uj-step-bar-bg">
                          <div class="uj-step-bar uj-bar-app" id="aj-searches-bar" style="width: 50%"></div>
                        </div>
                      </div>
                      <div class="uj-step-stats">
                        <span class="uj-step-count" id="aj-searches">--</span>
                        <span class="uj-step-pct" id="aj-searches-rate">--%</span>
                      </div>
                    </div>

                    <div class="uj-drop"><span class="uj-drop-pct" id="aj-drop-2">--%</span> left</div>

                    <div class="uj-step">
                      <div class="uj-step-num">3</div>
                      <div class="uj-step-content">
                        <div class="uj-step-label">Save Supplier</div>
                        <div class="uj-step-bar-bg">
                          <div class="uj-step-bar uj-bar-app" id="aj-saves-bar" style="width: 30%"></div>
                        </div>
                      </div>
                      <div class="uj-step-stats">
                        <span class="uj-step-count" id="aj-saves">--</span>
                        <span class="uj-step-pct" id="aj-saves-rate">--%</span>
                      </div>
                    </div>

                    <div class="uj-drop"><span class="uj-drop-pct" id="aj-drop-3">--%</span> left</div>

                    <div class="uj-step uj-step-goal">
                      <div class="uj-step-num">‚úì</div>
                      <div class="uj-step-content">
                        <div class="uj-step-label">Log Delivery</div>
                        <div class="uj-step-bar-bg">
                          <div class="uj-step-bar uj-bar-success" id="aj-deliveries-bar" style="width: 10%"></div>
                        </div>
                      </div>
                      <div class="uj-step-stats">
                        <span class="uj-step-count" id="aj-deliveries">--</span>
                        <span class="uj-step-pct" id="aj-deliveries-rate">--%</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="insight-box" id="journey-insight">
                üí° Loading journey insights...
              </div>
            </div>

            <!-- Recommendations (Moved from old tab) -->
            <div class="panel full-width">
              <h3>üéØ Top Recommendation</h3>
              <div class="top-recommendation" id="top-recommendation">
                <div class="rec-primary" id="rec-primary">
                  <div class="rec-badge">PRIMARY ACTION</div>
                  <div class="rec-title" id="rec-title">Loading...</div>
                  <div class="rec-insight" id="rec-insight"></div>
                </div>
                <div class="rec-secondary" id="rec-secondary">
                  <span class="rec-secondary-label">Also consider:</span>
                  <ul id="rec-secondary-list"></ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ============================================================ -->
      <!-- COVERAGE TAB - Scope 18 (Merged Map + Overview gaps + Geography) -->
      <!-- ============================================================ -->
      <section id="tab-coverage" class="tab-panel">
        <div class="coverage-container">
          <!-- Coverage Summary -->
          <div class="cards">
            <div class="card">
              <div class="card-label">Suppliers</div>
              <div class="card-value" id="cov-suppliers">--</div>
            </div>
            <div class="card">
              <div class="card-label">States Active</div>
              <div class="card-value" id="cov-states">--</div>
            </div>
            <div class="card">
              <div class="card-label">Active ZIPs</div>
              <div class="card-value" id="cov-active-zips">--</div>
              <div class="card-sub">ZIPs with user activity</div>
            </div>
            <div class="card">
              <div class="card-label">Coverage Gaps</div>
              <div class="card-value" id="cov-gaps">--</div>
              <div class="card-sub">ZIPs with demand, no suppliers</div>
            </div>
          </div>

          <!-- Map with View Toggle -->
          <div class="panel full-width">
            <div class="panel-header-with-toggle">
              <h3>üó∫Ô∏è Geographic Activity</h3>
              <div class="map-view-toggle">
                <button class="map-toggle-btn active" data-view="engagement">Engagement</button>
                <button class="map-toggle-btn" data-view="demand">Demand</button>
                <button class="map-toggle-btn" data-view="gaps">Gaps</button>
                <button class="map-toggle-btn" data-view="suppliers">Suppliers</button>
              </div>
            </div>
            <div id="map-stats" class="map-legend"></div>
            <div id="map-container" style="height: 450px;"></div>
          </div>

          <!-- State Breakdown and Top Locations side by side -->
          <div class="coverage-tables-grid">
            <div class="panel">
              <h3>üìä Activity by State</h3>
              <div class="table-scroll" style="max-height: 300px;">
                <table id="state-breakdown-table">
                  <thead>
                    <tr>
                      <th>State</th>
                      <th>ZIPs</th>
                      <th>Searches</th>
                      <th>Engagements</th>
                    </tr>
                  </thead>
                  <tbody id="state-breakdown-body"></tbody>
                </table>
              </div>
            </div>

            <div class="panel">
              <h3>üî• Top Active Locations</h3>
              <div class="table-scroll" style="max-height: 300px;">
                <table id="top-locations-table">
                  <thead>
                    <tr>
                      <th>Location</th>
                      <th>ZIP</th>
                      <th>Activity</th>
                    </tr>
                  </thead>
                  <tbody id="top-locations-body"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Coverage Gaps Table -->
          <div class="panel full-width">
            <h3>‚ö†Ô∏è Coverage Gaps (High Demand, No Suppliers)</h3>
            <table id="coverage-gaps-table">
              <thead>
                <tr>
                  <th>ZIP</th>
                  <th>Location</th>
                  <th>Searches</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="coverage-gaps-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ============================================================ -->
      <!-- SETTINGS TAB - Data Health + External Links -->
      <!-- ============================================================ -->
      <section id="tab-settings" class="tab-panel">
        <div class="settings-container">
          <!-- Data Health Summary -->
          <div class="panel full-width">
            <h3>üîß Data Health</h3>
            <div class="health-summary">
              <div class="health-stat">
                <span class="health-value" id="health-last-scrape">--</span>
                <span class="health-label">Last Scrape</span>
              </div>
              <div class="health-stat">
                <span class="health-value" id="health-prices">--</span>
                <span class="health-label">Live Prices</span>
              </div>
              <div class="health-stat warning">
                <span class="health-value" id="health-stale">--</span>
                <span class="health-label">Stale</span>
              </div>
            </div>
          </div>

          <!-- External Links -->
          <div class="panel full-width">
            <h3>üîó External Tools</h3>
            <div class="external-links">
              <a href="https://console.firebase.google.com/project/smartheat-e0729/analytics" target="_blank" class="ext-link">
                <span class="ext-icon">üî•</span>
                <span class="ext-name">Firebase Console</span>
              </a>
              <a href="https://analytics.google.com/" target="_blank" class="ext-link">
                <span class="ext-icon">üìä</span>
                <span class="ext-name">Google Analytics</span>
              </a>
              <a href="https://search.google.com/search-console" target="_blank" class="ext-link">
                <span class="ext-icon">üîç</span>
                <span class="ext-name">Search Console</span>
              </a>
            </div>
          </div>
        </div>
      </section>

      <!-- ============================================================ -->
      <!-- LEGACY TABS (Hidden, kept for backward compatibility) -->
      <!-- ============================================================ -->
      <section id="tab-recommendations" class="tab-panel hidden-legacy">
        <div class="recommendations-container">
          <div id="recommendations-loading" class="loading">Generating recommendations...</div>

          <div id="recommendations-content" class="hidden">
            <!-- HIGH Priority -->
            <div class="priority-section" id="section-high">
              <h3 class="priority-header high">HIGH PRIORITY</h3>
              <div class="recommendation-cards" id="cards-high"></div>
            </div>

            <!-- MEDIUM Priority -->
            <div class="priority-section" id="section-medium">
              <h3 class="priority-header medium">MEDIUM PRIORITY</h3>
              <div class="recommendation-cards" id="cards-medium"></div>
            </div>

            <!-- LOW / OPPORTUNITY -->
            <div class="priority-section" id="section-low">
              <h3 class="priority-header low">OPPORTUNITIES</h3>
              <div class="recommendation-cards" id="cards-low"></div>
            </div>
          </div>

          <div id="no-recommendations" class="hidden">
            <p class="success-message">All systems healthy - no urgent recommendations</p>
          </div>
        </div>
      </section>

      <!-- Website Tab (GA4 Data) -->
      <section id="tab-website" class="tab-panel">
        <div class="panel-grid">
          <div class="panel">
            <h3>Sessions</h3>
            <div id="web-sessions" class="stat-large">--</div>
            <div class="hint">Total visits in period</div>
          </div>
          <div class="panel">
            <h3>Unique Visitors</h3>
            <div id="web-users" class="stat-large">--</div>
            <div class="hint">Distinct users</div>
          </div>
          <div class="panel">
            <h3>Bounce Rate</h3>
            <div id="web-bounce" class="stat-large">--%</div>
            <div class="hint">Target: &lt;60%</div>
          </div>
          <div class="panel">
            <h3>Avg. Session</h3>
            <div id="web-duration" class="stat-large">--</div>
            <div class="hint">Time on site</div>
          </div>
          <div class="panel full-width">
            <h3>Traffic Sources</h3>
            <canvas id="web-traffic-chart"></canvas>
            <div id="web-traffic-note" class="hint"></div>
          </div>
          <div class="panel full-width">
            <h3>Daily Website Activity</h3>
            <div class="chart-container" style="position: relative; height: 250px;">
              <canvas id="web-daily-chart"></canvas>
            </div>
            <div id="web-daily-note" class="hint"></div>
          </div>
          <div class="panel">
            <h3>Top Pages</h3>
            <table id="web-pages-table">
              <thead>
                <tr>
                  <th>Page</th>
                  <th>Views</th>
                </tr>
              </thead>
              <tbody id="web-pages-body"></tbody>
            </table>
          </div>
          <div class="panel">
            <h3>Supplier Clicks</h3>
            <div id="web-clicks-summary">
              <div class="stat-row">
                <span>Total Clicks</span>
                <span id="web-total-clicks" class="stat-value">--</span>
              </div>
              <div class="stat-row">
                <span>Phone Calls</span>
                <span id="web-call-clicks" class="stat-value">--</span>
              </div>
              <div class="stat-row">
                <span>Website Visits</span>
                <span id="web-website-clicks" class="stat-value">--</span>
              </div>
            </div>
            <div class="hint" style="margin-top: 1rem;">From PostgreSQL tracking</div>
          </div>
          <div class="panel full-width">
            <h3>Supplier Clicks</h3>

            <!-- Summary Stats -->
            <div class="activity-summary">
              <div class="summary-stat">
                <span class="summary-value" id="activity-today">--</span>
                <span class="summary-label">Today</span>
              </div>
              <div class="summary-stat">
                <span class="summary-value" id="activity-week">--</span>
                <span class="summary-label">This Week</span>
              </div>
              <div class="summary-stat">
                <span class="summary-value" id="activity-calls">--</span>
                <span class="summary-label">Calls</span>
              </div>
              <div class="summary-stat">
                <span class="summary-value" id="activity-websites">--</span>
                <span class="summary-label">Websites</span>
              </div>
              <div class="summary-stat">
                <span class="summary-value" id="activity-top-supplier">--</span>
                <span class="summary-label">Top Supplier</span>
              </div>
              <div class="summary-stat">
                <span class="summary-value" id="activity-trend">--</span>
                <span class="summary-label">vs Last Week</span>
              </div>
            </div>

            <!-- Filters -->
            <div class="activity-filters">
              <select id="activity-date-filter" class="filter-select">
                <option value="7">Last 7 days</option>
                <option value="30" selected>Last 30 days</option>
                <option value="90">Last 90 days</option>
                <option value="">All time</option>
              </select>
              <select id="activity-action-filter" class="filter-select">
                <option value="">All Actions</option>
                <option value="call">Calls Only</option>
                <option value="website">Website Only</option>
              </select>
              <select id="activity-source-filter" class="filter-select">
                <option value="">All Sources</option>
                <option value="prices">Prices Page</option>
                <option value="seo-city">City Pages</option>
                <option value="seo-county">County Pages</option>
              </select>
              <input type="text" id="activity-supplier-search" class="filter-input" placeholder="Search supplier...">
            </div>

            <!-- Table -->
            <table id="activity-table" class="sortable-table">
              <thead>
                <tr>
                  <th data-sort="timestamp" class="sortable sorted-desc">Time ‚ñº</th>
                  <th data-sort="supplier" class="sortable">Supplier</th>
                  <th data-sort="action" class="sortable">Action</th>
                  <th data-sort="userZip" class="sortable">User ZIP</th>
                  <th data-sort="pageSource" class="sortable">Source</th>
                </tr>
              </thead>
              <tbody id="activity-body">
                <tr><td colspan="5" class="hint">Loading...</td></tr>
              </tbody>
            </table>

            <!-- Pagination -->
            <div class="activity-pagination">
              <button id="activity-prev" class="btn-small" disabled>‚Üê Prev</button>
              <span id="activity-page-info">Page 1 of 1</span>
              <button id="activity-next" class="btn-small" disabled>Next ‚Üí</button>
            </div>
          </div>
          <div class="panel full-width" id="web-ga4-setup" style="display: none;">
            <div class="setup-guide">
              <h3>Connect Google Analytics</h3>
              <p>Enable GA4 API to see detailed website traffic data.</p>
              <ol>
                <li>Go to <a href="https://console.cloud.google.com/apis/library/analyticsdata.googleapis.com" target="_blank">Google Cloud Console</a></li>
                <li>Enable "Google Analytics Data API"</li>
                <li>Create a service account with Viewer role</li>
                <li>Download JSON credentials</li>
                <li>Set <code>GOOGLE_APPLICATION_CREDENTIALS_JSON</code> env var</li>
                <li>Set <code>GA4_PROPERTY_ID</code> env var</li>
              </ol>
              <a href="https://analytics.google.com/" target="_blank" class="btn">Open GA4 Console</a>
            </div>
          </div>
        </div>
      </section>

      <!-- Retention Tab -->
      <section id="tab-retention" class="tab-panel">
        <div class="panel-grid">
          <!-- Day 1/7/30 Retention Cards -->
          <div class="panel">
            <h3>Day 1 Retention</h3>
            <div id="day1-retention" class="stat-large retention-stat">--%</div>
            <div class="hint">Target: 40%+</div>
          </div>
          <div class="panel">
            <h3>Day 7 Retention</h3>
            <div id="day7-retention" class="stat-large retention-stat">--%</div>
            <div class="hint">Target: 20%+</div>
          </div>
          <div class="panel">
            <h3>Day 30 Retention</h3>
            <div id="day30-retention" class="stat-large retention-stat">--%</div>
            <div class="hint">Target: 10%+</div>
          </div>
          <div class="panel">
            <h3>Total Users Tracked</h3>
            <div id="cohort-size" class="stat-large">--</div>
            <div class="hint">Combined web + app</div>
          </div>

          <!-- Retention Curve Chart -->
          <div class="panel full-width">
            <h3>Retention Curve (30 Days)</h3>
            <p class="hint">What % of users return each day after first visit</p>
            <canvas id="retention-curve-chart"></canvas>
          </div>

          <!-- Cohort Table -->
          <div class="panel full-width">
            <h3>Cohort Breakdown</h3>
            <p class="hint">Retention by user acquisition date</p>
            <div class="table-scroll">
              <table id="cohort-table">
                <thead>
                  <tr>
                    <th>Cohort Date</th>
                    <th>Users</th>
                    <th>Day 1</th>
                    <th>Day 7</th>
                    <th>Day 30</th>
                  </tr>
                </thead>
                <tbody id="cohort-table-body"></tbody>
              </table>
            </div>
          </div>

          <!-- Behavior Retention -->
          <div class="panel full-width">
            <h3>Retention by Behavior</h3>
            <p class="hint">Users who take certain actions stay longer</p>
            <table id="behavior-retention-table">
              <thead>
                <tr>
                  <th>Behavior</th>
                  <th>Users</th>
                  <th>Avg Active Days</th>
                  <th>Insight</th>
                </tr>
              </thead>
              <tbody id="behavior-retention-body"></tbody>
            </table>
          </div>

          <!-- Retention Ideas -->
          <div class="panel full-width">
            <h3>Retention Improvement Ideas</h3>
            <div id="retention-ideas" class="ideas-list">
              <div class="idea">
                <span class="idea-icon">1.</span>
                <span>Push users to log first delivery - retained users make calls</span>
              </div>
              <div class="idea">
                <span class="idea-icon">2.</span>
                <span>Add price drop alerts to bring users back</span>
              </div>
              <div class="idea">
                <span class="idea-icon">3.</span>
                <span>Weekly "your area prices" email for opted-in users</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Acquisition Tab -->
      <section id="tab-acquisition" class="tab-panel">
        <div class="panel-grid">
          <div class="panel">
            <h3>Total Sessions</h3>
            <div id="acq-sessions" class="stat-large">--</div>
            <div class="hint" id="acq-sessions-source">From GA4</div>
          </div>
          <div class="panel">
            <h3>Organic %</h3>
            <div id="acq-organic" class="stat-large">--%</div>
            <div class="hint">Target: 30%+</div>
          </div>
          <div class="panel">
            <h3>Search ‚Üí Click Rate</h3>
            <div id="acq-conversion" class="stat-large">--%</div>
          </div>
          <div class="panel full-width">
            <h3>Traffic Sources</h3>
            <canvas id="traffic-sources-chart"></canvas>
            <div id="traffic-sources-note" class="hint"></div>
          </div>
          <div class="panel full-width">
            <h3>Daily Conversion Funnel</h3>
            <canvas id="acquisition-funnel-chart"></canvas>
          </div>
          <div class="panel full-width">
            <h3>Top Converting Locations</h3>
            <table id="converting-locations-table">
              <thead>
                <tr>
                  <th>ZIP</th>
                  <th>City</th>
                  <th>Searches</th>
                  <th>Clicks</th>
                  <th>Conversion</th>
                </tr>
              </thead>
              <tbody id="converting-locations-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Android Decision Tab (Legacy) -->
      <section id="tab-android" class="tab-panel">
        <div class="panel-grid">
          <div class="panel decision-card" id="legacy-android-decision">
            <h3>Android Decision</h3>
            <div id="legacy-android-status" class="decision-status">WAIT</div>
            <div id="legacy-android-message" class="decision-message">Loading...</div>
          </div>
          <div class="panel">
            <h3>Waitlist Total</h3>
            <div id="android-waitlist" class="stat-large">--</div>
            <div class="hint">Target: 200</div>
          </div>
          <div class="panel">
            <h3>Weekly Growth</h3>
            <div id="android-growth" class="stat-large">--%</div>
            <div class="hint">Target: 5%+</div>
          </div>
          <div class="panel">
            <h3>PWA Installs</h3>
            <div id="android-pwa" class="stat-large">--</div>
            <div class="hint" id="android-pwa-rate">--% conversion</div>
          </div>
          <div class="panel full-width">
            <h3>PWA Funnel</h3>
            <div class="pwa-funnel">
              <div class="pwa-funnel-step">
                <div class="pwa-funnel-value" id="pwa-prompts">--</div>
                <div class="pwa-funnel-label">Install Prompts</div>
              </div>
              <div class="pwa-funnel-arrow">‚Üí</div>
              <div class="pwa-funnel-step">
                <div class="pwa-funnel-value" id="pwa-installs-detail">--</div>
                <div class="pwa-funnel-label">Installs</div>
              </div>
              <div class="pwa-funnel-arrow">‚Üí</div>
              <div class="pwa-funnel-step">
                <div class="pwa-funnel-value" id="pwa-launches">--</div>
                <div class="pwa-funnel-label">App Launches</div>
              </div>
            </div>
            <div class="hint" style="text-align: center; margin-top: 1rem;">PWA serves Android users until native app launches</div>
          </div>
          <div class="panel full-width">
            <h3>Website Visitors by Platform (from GA4)</h3>
            <div class="platform-breakdown" id="platform-breakdown">
              <div class="platform-item">
                <span class="platform-icon">üçé</span>
                <span class="platform-name">iOS</span>
                <span class="platform-value" id="platform-ios">--%</span>
                <span class="platform-users" id="platform-ios-users">-- users</span>
              </div>
              <div class="platform-item">
                <span class="platform-icon">ü§ñ</span>
                <span class="platform-name">Android</span>
                <span class="platform-value" id="platform-android">--%</span>
                <span class="platform-users" id="platform-android-users">-- users</span>
              </div>
              <div class="platform-item">
                <span class="platform-icon">üñ•Ô∏è</span>
                <span class="platform-name">Desktop</span>
                <span class="platform-value" id="platform-desktop">--%</span>
                <span class="platform-users" id="platform-desktop-users">-- users</span>
              </div>
            </div>
            <div class="hint" id="platform-note"></div>
          </div>
          <div class="panel full-width">
            <h3>Threshold Status</h3>
            <div class="thresholds-grid" id="thresholds-grid">
              <!-- Filled by JS -->
            </div>
          </div>
          <div class="panel full-width">
            <h3>Weekly Waitlist Trend</h3>
            <canvas id="android-trend-chart"></canvas>
          </div>
          <div class="panel full-width">
            <h3>Projection</h3>
            <div id="android-projection" class="projection-box">
              <div class="projection-item">
                <span class="projection-label">Weeks to 200:</span>
                <span class="projection-value" id="weeks-to-200">--</span>
              </div>
              <div class="projection-item">
                <span class="projection-label">Expected launch users (30% conv):</span>
                <span class="projection-value" id="expected-users">--</span>
              </div>
              <div class="projection-item">
                <span class="projection-label">Break-even threshold:</span>
                <span class="projection-value">100 active users</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Overview Tab -->
      <section id="tab-overview" class="tab-panel">
        <div class="overview-grid">
          <!-- Top Row: Key Metrics -->
          <div class="overview-metrics">
            <div class="metric-card">
              <div class="metric-icon">üèÜ</div>
              <div class="metric-content">
                <div class="metric-label">Top Supplier</div>
                <div class="metric-value" id="top-supplier">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-icon">üìç</div>
              <div class="metric-content">
                <div class="metric-label">Total Searched</div>
                <div class="metric-value" id="total-searched">-- ZIPs</div>
                <div class="metric-hint">Unique ZIPs in period</div>
              </div>
            </div>
          </div>

          <!-- Coverage Gap Cards -->
          <div class="coverage-cards">
            <div class="coverage-card danger clickable" id="panel-no-suppliers" title="Click to view ZIPs">
              <div class="coverage-icon">‚ö†Ô∏è</div>
              <div class="coverage-content">
                <div class="coverage-label">No Suppliers</div>
                <div class="coverage-value" id="true-coverage-gaps">-- ZIPs</div>
                <div class="coverage-hint">Users searching areas with zero coverage</div>
              </div>
              <div class="coverage-action">View List ‚Üí</div>
            </div>
            <div class="coverage-card warning clickable" id="panel-low-engagement" title="Click to view ZIPs">
              <div class="coverage-icon">üìâ</div>
              <div class="coverage-content">
                <div class="coverage-label">Low Engagement</div>
                <div class="coverage-value" id="engagement-gaps">-- ZIPs</div>
                <div class="coverage-hint">Has suppliers but no clicks yet</div>
              </div>
              <div class="coverage-action">View List ‚Üí</div>
            </div>
          </div>

          <!-- Conversion Funnel -->
          <div class="funnel-section">
            <h3>Conversion Funnel</h3>
            <div class="funnel-visual">
              <div class="funnel-step">
                <div class="funnel-bar searches-bar" id="funnel-searches-bar"></div>
                <div class="funnel-label">
                  <span class="funnel-count" id="funnel-searches">--</span>
                  <span class="funnel-name">Searches</span>
                </div>
              </div>
              <div class="funnel-arrow">‚Üí</div>
              <div class="funnel-step">
                <div class="funnel-bar clicks-bar" id="funnel-clicks-bar"></div>
                <div class="funnel-label">
                  <span class="funnel-count" id="funnel-clicks">--</span>
                  <span class="funnel-name">Clicks</span>
                </div>
              </div>
              <div class="funnel-rate">
                <span id="funnel-rate">--%</span> conversion
              </div>
            </div>
          </div>

          <!-- Price Alerts -->
          <div class="panel full-width" id="price-alerts-panel" style="display: none;">
            <h3>‚ö†Ô∏è Price Alerts</h3>
            <div id="price-alerts-content"></div>
          </div>

          <!-- Supplier Signals Table -->
          <div class="panel full-width">
            <h3>Supplier Signals</h3>
            <table id="supplier-signals-table">
              <thead>
                <tr>
                  <th>Supplier</th>
                  <th>Clicks</th>
                  <th>Price</th>
                  <th>vs Market</th>
                  <th>Est. Revenue</th>
                  <th>Signal</th>
                </tr>
              </thead>
              <tbody id="supplier-signals-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Searches Tab -->
      <section id="tab-searches" class="tab-panel">
        <div class="panel-grid">
          <div class="panel">
            <h3>Total Searches</h3>
            <div id="searches-total" class="stat-large">--</div>
            <div class="hint" id="searches-avg">-- avg/day</div>
          </div>
          <div class="panel">
            <h3>Unique ZIPs</h3>
            <div id="searches-zips" class="stat-large">--</div>
          </div>
          <div class="panel full-width">
            <h3>Daily Search Volume</h3>
            <canvas id="searches-chart"></canvas>
          </div>
          <div class="panel">
            <h3>Peak Hours</h3>
            <canvas id="peak-hours-chart"></canvas>
          </div>
          <div class="panel">
            <h3>Top Searched ZIPs</h3>
            <table id="top-zips-table">
              <thead>
                <tr>
                  <th>ZIP</th>
                  <th>City</th>
                  <th>State</th>
                  <th>Searches</th>
                </tr>
              </thead>
              <tbody id="top-zips-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- iOS App Tab -->
      <section id="tab-ios-app" class="tab-panel">
        <div class="panel-grid">
          <div class="panel">
            <h3>App Installs</h3>
            <div id="ios-installs" class="stat-large">--</div>
            <div class="hint">Total installs</div>
          </div>
          <div class="panel">
            <h3>Monthly Active Users</h3>
            <div id="ios-mau" class="stat-large">--</div>
            <div class="hint" id="ios-mau-percent">--% of installs</div>
          </div>
          <div class="panel">
            <h3>Week 1 Retention</h3>
            <div id="ios-retention" class="stat-large retention-stat">--%</div>
            <div class="hint">Target: 30%+</div>
          </div>
          <div class="panel">
            <h3>Deliveries Logged</h3>
            <div id="ios-deliveries" class="stat-large">--</div>
            <div class="hint">Real orders</div>
          </div>
          <div class="panel full-width">
            <h3>App Event Breakdown</h3>
            <div class="ios-events-grid" id="ios-events-grid">
              <div class="event-item">
                <span class="event-name">Supplier Selected</span>
                <span class="event-count" id="ios-event-supplier">--</span>
              </div>
              <div class="event-item">
                <span class="event-name">Price Checked</span>
                <span class="event-count" id="ios-event-price">--</span>
              </div>
              <div class="event-item">
                <span class="event-name">Directory Searched</span>
                <span class="event-count" id="ios-event-search">--</span>
              </div>
              <div class="event-item">
                <span class="event-name">No Results Shown</span>
                <span class="event-count" id="ios-event-noresults">--</span>
              </div>
            </div>
          </div>
          <div class="panel full-width">
            <h3>Daily App Engagement</h3>
            <canvas id="ios-chart"></canvas>
          </div>
          <div class="panel full-width">
            <h3>Top Suppliers in App</h3>
            <table id="ios-suppliers-table">
              <thead>
                <tr>
                  <th>Supplier</th>
                  <th>Views</th>
                  <th>Calls</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody id="ios-suppliers-body"></tbody>
            </table>
          </div>
          <!-- Firebase Setup Guide (shown when not configured) -->
          <div class="panel full-width" id="ios-firebase-setup" style="display: none;">
            <div class="setup-guide">
              <h3>Connect Firebase Analytics</h3>
              <p>Enable Firebase API to see detailed iOS app analytics including retention cohorts, user journeys, and event funnels.</p>
              <ol>
                <li>Go to <a href="https://console.firebase.google.com/project/smartheat-e0729/settings/serviceaccounts/adminsdk" target="_blank">Firebase Console &gt; Service Accounts</a></li>
                <li>Click "Generate new private key"</li>
                <li>Download the JSON file</li>
                <li>Base64 encode it: <code>base64 -i serviceAccount.json</code></li>
                <li>Set <code>GOOGLE_APPLICATION_CREDENTIALS_JSON</code> env var with the encoded value</li>
                <li>Set <code>FIREBASE_PROJECT_ID=smartheat-e0729</code></li>
              </ol>
              <div class="setup-actions">
                <a href="https://console.firebase.google.com/project/smartheat-e0729/analytics" target="_blank" class="btn">Open Firebase Console</a>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Clicks Tab -->
      <section id="tab-clicks" class="tab-panel">
        <div class="panel-grid">
          <div class="panel full-width">
            <h3>Daily Clicks</h3>
            <canvas id="clicks-chart"></canvas>
          </div>
          <div class="panel">
            <h3>By Page Source</h3>
            <canvas id="page-source-chart"></canvas>
          </div>
          <div class="panel">
            <h3>By Device</h3>
            <canvas id="device-chart"></canvas>
          </div>
          <div class="panel full-width">
            <h3>Top Suppliers by Clicks</h3>
            <table id="clicks-by-supplier-table">
              <thead>
                <tr>
                  <th>Supplier</th>
                  <th>Calls</th>
                  <th>Websites</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody id="clicks-by-supplier-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Prices Tab -->
      <section id="tab-prices" class="tab-panel">
        <div class="panel-grid">
          <div class="panel full-width">
            <h3>Price Trends</h3>
            <canvas id="price-chart"></canvas>
          </div>
          <div class="panel full-width">
            <h3>Price Spread by State (Marketing Opportunity)</h3>
            <canvas id="spread-chart"></canvas>
            <p class="hint">Higher spread = easier marketing ("Save up to $X/gal!")</p>
          </div>
          <div class="panel full-width">
            <h3>Current Prices by Supplier</h3>
            <table id="prices-table">
              <thead>
                <tr>
                  <th>Supplier</th>
                  <th>State</th>
                  <th>Price</th>
                  <th>Last Updated</th>
                </tr>
              </thead>
              <tbody id="prices-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Map Tab (Legacy) -->
      <section id="tab-map" class="tab-panel">
        <div class="panel full-width">
          <h3>Demand Heatmap & Coverage Gaps</h3>
          <div id="legacy-map-stats" class="map-legend"></div>
          <div id="legacy-map-container"></div>
        </div>
        <div class="panel full-width">
          <h3>Supplier Clicks by Location</h3>
          <table>
            <thead>
              <tr>
                <th>ZIP</th>
                <th>City</th>
                <th>County</th>
                <th>State</th>
                <th>Clicks</th>
              </tr>
            </thead>
            <tbody id="geo-clicks-body"></tbody>
          </table>
        </div>
      </section>

      <!-- Scrapers Tab (Legacy) -->
      <section id="tab-scrapers" class="tab-panel">
        <div class="panel-grid">
          <div class="panel">
            <h3>Last Scrape Run</h3>
            <div id="legacy-last-scrape" class="stat-large">--</div>
          </div>
          <div class="panel">
            <h3>Suppliers Scraped</h3>
            <div id="legacy-suppliers-scraped" class="stat-large">--</div>
          </div>
          <div class="panel full-width">
            <h3>Stale Suppliers (No update in 48h)</h3>
            <table id="legacy-stale-table">
              <thead>
                <tr>
                  <th>Supplier</th>
                  <th>Last Price</th>
                  <th>Last Updated</th>
                  <th>Website</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="legacy-stale-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Suppliers Tab -->
      <section id="tab-suppliers" class="tab-panel">
        <div class="suppliers-container">
          <!-- Supplier Management -->
          <div class="panel full-width">
            <h3>üè¢ Supplier Management</h3>
            <div class="supplier-filters">
              <div class="filter-row">
                <input type="text" id="filter-search" placeholder="üîç Search by name, city, or website..." class="search-input">
                <button id="filter-apply" class="btn-primary">Search</button>
                <button id="filter-clear" class="btn-secondary">Clear</button>
              </div>
              <div class="filter-row">
                <select id="filter-state">
                  <option value="">All States</option>
                </select>
                <select id="filter-price">
                  <option value="">All Price Status</option>
                  <option value="true">Has Price</option>
                  <option value="false">No Price</option>
                </select>
                <select id="filter-scrape">
                  <option value="">All Scrape Status</option>
                  <option value="fresh">Fresh (&lt; 48h)</option>
                  <option value="stale">Stale (&gt; 48h)</option>
                </select>
                <select id="filter-active">
                  <option value="">All Status</option>
                  <option value="true">Active Only</option>
                  <option value="false">Inactive Only</option>
                </select>
              </div>
            </div>
            <div class="table-info">
              <span id="results-count">Loading...</span>
              <div class="bulk-actions hidden" id="bulk-actions">
                <button class="btn-small" id="export-csv">üì• Export CSV</button>
              </div>
            </div>
            <table id="suppliers-table" class="enhanced-table">
              <thead>
                <tr>
                  <th class="sortable" data-sort="name">Supplier <span class="sort-icon">‚Üï</span></th>
                  <th class="sortable" data-sort="price">Price <span class="sort-icon">‚Üï</span></th>
                  <th class="sortable" data-sort="updated">Updated <span class="sort-icon">‚Üï</span></th>
                  <th class="sortable" data-sort="clicks">Clicks <span class="sort-icon">‚Üï</span></th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="suppliers-body"></tbody>
            </table>
            <div class="pagination">
              <button id="prev-page" disabled>‚Üê Previous</button>
              <span id="page-info">Page 1</span>
              <button id="next-page">Next ‚Üí</button>
            </div>
          </div>
        </div>
      </section>

      <!-- External Tab -->
      <section id="tab-external" class="tab-panel">
        <div class="panel-grid">
          <div class="panel">
            <h3>Firebase Analytics (iOS App)</h3>
            <p>View detailed iOS app analytics including supplier_selected, delivery_logged, and other custom events.</p>
            <a href="https://console.firebase.google.com/project/smartheat-e0729/analytics" target="_blank" class="btn">Open Firebase Console</a>
          </div>
          <div class="panel">
            <h3>Google Analytics 4 (Website)</h3>
            <p>View website traffic, user behavior, and conversion data.</p>
            <a href="https://analytics.google.com/" target="_blank" class="btn">Open Google Analytics</a>
          </div>
          <div class="panel">
            <h3>Google Search Console</h3>
            <p>Monitor search performance, indexing status, and SEO issues.</p>
            <a href="https://search.google.com/search-console" target="_blank" class="btn">Open Search Console</a>
          </div>
        </div>
      </section>
    </main>
    </div><!-- End main-content -->

    <!-- Supplier Edit Modal -->
    <div id="supplier-modal" class="modal hidden">
      <div class="modal-content wide">
        <h2>Edit Supplier: <span id="edit-supplier-name"></span></h2>
        <form id="supplier-form">
          <input type="hidden" id="edit-supplier-id">

          <fieldset>
            <legend>Basic Info</legend>
            <div class="form-row">
              <label>Name</label>
              <input type="text" id="edit-name" required>
            </div>
            <div class="form-row">
              <label>Phone</label>
              <input type="tel" id="edit-phone">
            </div>
            <div class="form-row">
              <label>Website</label>
              <input type="url" id="edit-website">
            </div>
            <div class="form-row">
              <label>State</label>
              <input type="text" id="edit-state" maxlength="2">
            </div>
            <div class="form-row">
              <label>City</label>
              <input type="text" id="edit-city">
            </div>
          </fieldset>

          <fieldset>
            <legend>Display Settings</legend>
            <div class="form-row checkbox">
              <label><input type="checkbox" id="edit-active"> Show in directory</label>
            </div>
            <div class="form-row checkbox">
              <label><input type="checkbox" id="edit-price-display"> Allow price display</label>
            </div>
            <div class="form-row checkbox">
              <label><input type="checkbox" id="edit-scraping"> Scraping enabled</label>
            </div>
          </fieldset>

          <fieldset>
            <legend>Price Info</legend>
            <div class="form-row">
              <label>Current Price ($)</label>
              <input type="number" id="edit-price" step="0.01" min="1.5" max="8" placeholder="e.g. 3.49">
              <small class="hint">$1.50 - $8.00, or leave blank for scraped price</small>
            </div>
            <div class="form-row">
              <label>Last Updated</label>
              <input type="text" id="edit-price-date" readonly class="readonly-field">
            </div>
            <div class="form-row">
              <label>Price Source</label>
              <input type="text" id="edit-price-source" readonly class="readonly-field">
            </div>
          </fieldset>

          <!-- Hours & Availability -->
          <fieldset>
            <legend>Hours & Availability</legend>

            <div class="form-row">
              <label>Weekday Hours</label>
              <input type="text" id="edit-hours-weekday" placeholder="e.g., 7am-5pm">
            </div>

            <div class="form-row">
              <label>Saturday Hours</label>
              <input type="text" id="edit-hours-saturday" placeholder="e.g., 8am-12pm or Closed">
            </div>

            <div class="form-row">
              <label>Sunday Hours</label>
              <input type="text" id="edit-hours-sunday" placeholder="e.g., Closed">
            </div>

            <div class="form-row">
              <label>Weekend Delivery</label>
              <select id="edit-weekend-delivery">
                <option value="unknown">Unknown</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>

            <div class="form-row">
              <label>Emergency Delivery</label>
              <select id="edit-emergency-delivery">
                <option value="unknown">Unknown</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>

            <div class="form-row">
              <label>Emergency Phone</label>
              <input type="tel" id="edit-emergency-phone" placeholder="Optional separate number">
            </div>

            <div class="form-row">
              <label>Notes (internal)</label>
              <textarea id="edit-hours-notes" rows="2" placeholder="e.g., Emergency for existing customers only"></textarea>
            </div>

            <div class="form-row checkbox">
              <label>
                <input type="checkbox" id="edit-hours-verified">
                Mark as Verified
                <small class="hint">(Shows badges to users when checked)</small>
              </label>
            </div>
          </fieldset>

          <fieldset>
            <legend>Click Stats (7 days)</legend>
            <div id="edit-click-stats" class="stats-grid"></div>
          </fieldset>

          <div class="form-actions">
            <button type="button" id="cancel-edit" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ZIP Details Modal -->
    <div id="zip-details-modal" class="modal hidden">
      <div class="modal-content wide">
        <h2 id="zip-details-title">ZIP Details</h2>
        <div id="zip-details-content">
          <p>Loading...</p>
        </div>
        <div class="form-actions">
          <button type="button" id="close-zip-details">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="dashboard.js?v=1770245437"></script>
</body>
</html>
