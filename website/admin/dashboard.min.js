let authToken=sessionStorage.getItem("dashboardToken")||"",currentDays=30,suppliersPage=0;const suppliersLimit=50;let clicksChart=null,pageSourceChart=null,deviceChart=null,priceChart=null,spreadChart=null,map=null;const API_BASE="/api/dashboard";function formatPrice(e){return e?"$"+parseFloat(e).toFixed(2):"--"}function formatDate(e){if(!e)return"--";return new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})}function timeAgo(e){if(!e)return"--";const t=new Date(e),n=new Date,a=Math.floor((n-t)/1e3);return a<60?`${a}s ago`:a<3600?`${Math.floor(a/60)}m ago`:a<86400?`${Math.floor(a/3600)}h ago`:`${Math.floor(a/86400)}d ago`}function trendArrow(e){if(!e||"flat"===e.direction)return'<span class="trend flat">‚Äî</span>';const t="up"===e.direction?"‚Üë":"‚Üì";return`<span class="trend ${"up"===e.direction?"trend-up":"trend-down"}">${t} ${e.display}</span>`}function updateDataSourceBanner(e){const t=document.getElementById("data-source-warnings"),n=document.getElementById("data-source-text"),a=document.getElementById("data-source-details");if(!t)return;const o=!0===e?.dataSources?.ga4,s=!0===e?.dataSources?.firebase,i=!1!==e?.dataSources?.database,r=sessionStorage.getItem("dataSourceBannerDismissed");if(o&&s)t.classList.add("hidden");else{if(r)return void t.classList.add("hidden");const e=[];o||e.push("GA4"),s||e.push("Firebase");const d=!o&&!s;n.textContent=d?"Analytics services not connected":`${e.join(" & ")} not connected`;let l="";l+=`<span class="banner-tag ${o?"connected":"disconnected"}">\n      ${o?"‚úì":"‚úó"} GA4 (Website)\n    </span>`,l+=`<span class="banner-tag ${s?"connected":"disconnected"}">\n      ${s?"‚úì":"‚úó"} Firebase (iOS)\n    </span>`,l+=`<span class="banner-tag ${i?"connected":"disconnected"}">\n      ${i?"‚úì":"‚úó"} Database\n    </span>`,a.innerHTML=l,t.classList.remove("hidden"),t.classList.toggle("error",d)}}async function api(e,t={}){const n=`${API_BASE}${e}`,a={"Content-Type":"application/json",Authorization:`Bearer ${authToken}`};try{const e=await fetch(n,{...t,headers:a,cache:"no-store"});if(401===e.status)throw sessionStorage.removeItem("dashboardToken"),authToken="",showLogin(),new Error("Authentication required");if(!e.ok){const t=await e.json();throw new Error(t.details||t.error||"API error")}return await e.json()}catch(e){throw console.error("API error:",e),e}}function showLogin(){document.getElementById("login-modal").classList.remove("hidden"),document.getElementById("dashboard").classList.add("hidden")}function showDashboard(){document.getElementById("login-modal").classList.add("hidden"),document.getElementById("dashboard").classList.remove("hidden"),loadDashboard()}function handleTabSwitch(e){document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active"));const t=document.querySelector(`.tab[data-tab="${e}"]`);t&&t.classList.add("active"),document.querySelectorAll(".sidebar .nav-item").forEach(e=>e.classList.remove("active"));const n=document.querySelector(`.sidebar .nav-item[data-tab="${e}"]`);n&&n.classList.add("active");const a=document.getElementById("page-title");if(a&&n){const t=n.querySelector(".nav-item-label");a.textContent=t?t.textContent:e}document.querySelectorAll(".tab-panel").forEach(e=>e.classList.remove("active"));const o=document.getElementById(`tab-${e}`);o&&o.classList.add("active"),closeMobileSidebar(),"leaderboard"===e&&loadLeaderboard(),"app-analytics"===e&&loadAppAnalytics(),"growth"===e&&loadGrowth(),"coverage"===e&&loadCoverage(),"settings"===e&&loadSettings(),"recommendations"===e&&loadRecommendations(),"website"===e&&loadWebsite(),"ios-app"===e&&loadIOSApp(),"android"===e&&loadAndroidSignals(),"retention"===e&&loadRetention(),"acquisition"===e&&loadAcquisition(),"overview"===e&&loadOverviewTab(),"searches"===e&&loadSearches(),"clicks"===e&&loadClicks(),"prices"===e&&loadPrices(),"map"===e&&loadMap(),"scrapers"===e&&loadScrapers(),"suppliers"===e&&loadSuppliers()}function openMobileSidebar(){document.getElementById("sidebar")?.classList.add("open"),document.getElementById("sidebar-overlay")?.classList.add("visible"),document.body.style.overflow="hidden"}function closeMobileSidebar(){document.getElementById("sidebar")?.classList.remove("open"),document.getElementById("sidebar-overlay")?.classList.remove("visible"),document.body.style.overflow=""}function updateHeaderMetrics(e){const t=document.getElementById("header-users"),n=document.getElementById("header-revenue"),a=document.getElementById("header-deliveries");t&&void 0!==e?.totalUsers&&(t.textContent=e.totalUsers.toLocaleString()),n&&void 0!==e?.revenue?.current&&(n.textContent="$"+e.revenue.current.toLocaleString()),a&&void 0!==e?.deliveries?.total&&(a.textContent=e.deliveries.total.toLocaleString())}function showTab(e){const t=document.querySelector(`.tab[data-tab="${e}"]`);t&&t.click()}async function loadOverview(){try{const e=await api(`/overview?days=${currentDays}`);let t=null;try{t=await api(`/unified?days=${currentDays}`)}catch(e){console.log("Unified data not available")}updateDataSourceBanner(t),t&&updateHeaderMetrics({totalUsers:(t?.app?.summary?.totalUsers||0)+(t?.website?.activeUsers||0),revenue:{current:Math.round(.03*(e.website?.totalClicks||0)*7.5)},deliveries:{total:t?.app?.deliveries?.total??t?.app?.saves??0}});const n=t?.trends||{},a=t?.dataSources?.ga4,o=t?.app?.summary?.totalUsers||t?.app?.uniqueUsers||e.users?.ios||0,s=a?t?.website?.activeUsers||0:e.users?.website||0,i=o+s;if(document.getElementById("total-users").textContent=i||"--",document.getElementById("users-breakdown").innerHTML=`${o} iOS / ${s} website`,i>0){const e=n.iosUsers||n.websiteUsers;document.getElementById("users-freshness").innerHTML=(a?"via GA4":"unique searches")+(e?" "+trendArrow(e):"")}else document.getElementById("users-freshness").textContent="No activity yet";const r=t?.app?.deliveries?.total??t?.app?.saves??0;document.getElementById("total-deliveries").textContent=r,document.getElementById("deliveries-breakdown").textContent=r>0?`~$${(500*r).toLocaleString()} in orders`:"No deliveries logged yet",document.getElementById("deliveries-freshness").textContent="";const d=e.website.totalClicks||0,l=Math.round(.03*d*7.5);document.getElementById("est-revenue").textContent=l>0?`~$${l}`:"--",document.getElementById("revenue-breakdown").textContent=`${d} clicks @ 3% conv`;const c=e.dataFreshness?.supplier_clicks,p=n.clicks;document.getElementById("revenue-freshness").innerHTML=(c?timeAgo(c):"")+(p?" "+trendArrow(p):""),document.getElementById("waitlist-total").textContent=e.waitlist.total;const u=n.waitlist;document.getElementById("waitlist-recent").innerHTML=`+${e.waitlist.last7Days} this week`+(u?" "+trendArrow(u):"");const m=e.waitlist?.lastUpdated;document.getElementById("waitlist-freshness").textContent=m?timeAgo(m):"",e.website.topSupplier&&(document.getElementById("top-supplier").textContent=`${e.website.topSupplier.name} (${e.website.topSupplier.clicks} clicks)`);const g=e.coverage||{},y=g.trueCoverageGaps||0,h=g.engagementGaps||0,b=g.totalSearched||0;document.getElementById("true-coverage-gaps").textContent=`${y} ZIPs`,document.getElementById("engagement-gaps").textContent=`${h} ZIPs`,document.getElementById("total-searched").textContent=`${b} ZIPs`,document.getElementById("panel-no-suppliers").onclick=()=>showCoverageDetails("no-suppliers"),document.getElementById("panel-low-engagement").onclick=()=>showCoverageDetails("low-engagement"),y>5?(document.getElementById("alert-banner").classList.remove("hidden"),document.getElementById("alert-text").textContent=`${y} ZIPs have demand but NO suppliers - add coverage!`,document.getElementById("alert-action").textContent="View Map",document.getElementById("alert-action").onclick=()=>switchTab("map")):h>20&&(document.getElementById("alert-banner").classList.remove("hidden"),document.getElementById("alert-text").textContent=`${h} ZIPs have suppliers but no clicks - check pricing/visibility`,document.getElementById("alert-action").textContent="View Clicks",document.getElementById("alert-action").onclick=()=>switchTab("clicks"))}catch(e){console.error("Failed to load overview:",e)}}async function loadOverviewTab(){await Promise.all([loadSupplierSignals(),loadConversion(),loadPriceAlerts()])}document.getElementById("dismiss-banner")?.addEventListener("click",()=>{document.getElementById("data-source-warnings")?.classList.add("hidden"),sessionStorage.setItem("dataSourceBannerDismissed","true")}),document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("password").value;authToken=t;try{await api("/meta"),sessionStorage.setItem("dashboardToken",t),showDashboard()}catch(e){document.getElementById("login-error").textContent="Invalid password"}}),document.querySelectorAll(".tab").forEach(e=>{e.addEventListener("click",()=>{handleTabSwitch(e.dataset.tab)})}),document.querySelectorAll(".sidebar .nav-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;t&&handleTabSwitch(t)})}),document.getElementById("mobile-menu-btn")?.addEventListener("click",openMobileSidebar),document.getElementById("sidebar-overlay")?.addEventListener("click",closeMobileSidebar),document.getElementById("legacy-toggle")?.addEventListener("click",()=>{const e=document.getElementById("legacy-nav-section");e?.classList.toggle("collapsed")}),window.showTab=showTab,document.getElementById("priority-view-details")?.addEventListener("click",()=>{showTab("recommendations")}),document.querySelectorAll(".period-btn").forEach(e=>{e.addEventListener("click",()=>{currentDays=parseInt(e.dataset.days),document.querySelectorAll(".period-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),loadDashboard()})});let webTrafficChart=null,webDailyChart=null;async function loadWebsite(){try{const[e,t]=await Promise.all([api(`/unified?days=${currentDays}`).catch(()=>null),api(`/clicks?days=${currentDays}`)]),n=e?.website||{},a=!0===e?.dataSources?.ga4;a?(document.getElementById("web-sessions").textContent=n.sessions?.toLocaleString()||"--",document.getElementById("web-users").textContent=n.activeUsers?.toLocaleString()||"--",document.getElementById("web-bounce").textContent=n.bounceRate?`${n.bounceRate}%`:"--%",document.getElementById("web-duration").textContent=n.avgSessionDuration||"--",document.getElementById("web-ga4-setup").style.display="none"):(document.getElementById("web-sessions").textContent="--",document.getElementById("web-users").textContent="--",document.getElementById("web-bounce").textContent="--%",document.getElementById("web-duration").textContent="--",document.getElementById("web-ga4-setup").style.display="block");const o=t.daily?.reduce((e,t)=>e+t.calls+t.websites,0)||0,s=t.daily?.reduce((e,t)=>e+t.calls,0)||0,i=t.daily?.reduce((e,t)=>e+t.websites,0)||0;if(document.getElementById("web-total-clicks").textContent=o,document.getElementById("web-call-clicks").textContent=s,document.getElementById("web-website-clicks").textContent=i,a&&n.trafficSources?.length>0){const e=document.getElementById("web-traffic-chart").getContext("2d");webTrafficChart&&webTrafficChart.destroy(),webTrafficChart=new Chart(e,{type:"bar",data:{labels:n.trafficSources.map(e=>e.channel),datasets:[{label:"Sessions",data:n.trafficSources.map(e=>e.sessions),backgroundColor:["#2563eb","#22c55e","#f59e0b","#ef4444","#8b5cf6"]}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{beginAtZero:!0}}}}),document.getElementById("web-traffic-note").textContent=""}else document.getElementById("web-traffic-note").textContent=a?"No traffic data in period":"Enable GA4 API for traffic sources";const r=document.getElementById("web-daily-note");if(t.daily?.length>0){const e=document.getElementById("web-daily-chart").getContext("2d");webDailyChart&&webDailyChart.destroy(),webDailyChart=new Chart(e,{type:"line",data:{labels:t.daily.map(e=>e.date),datasets:[{label:"Phone Calls",data:t.daily.map(e=>e.calls),borderColor:"#2563eb",backgroundColor:"rgba(37, 99, 235, 0.1)",fill:!0},{label:"Website Clicks",data:t.daily.map(e=>e.websites),borderColor:"#22c55e",backgroundColor:"rgba(34, 197, 94, 0.1)",fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}}),r.textContent=""}else r.textContent="No click data for selected period";const d=document.getElementById("web-pages-body");d.innerHTML="",a&&n.topPages?.length>0?n.topPages.slice(0,10).forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n          <td>${e.path}</td>\n          <td>${e.views?.toLocaleString()}</td>\n        `,d.appendChild(t)}):d.innerHTML='<tr><td colspan="2" class="no-data">Enable GA4 for page data</td></tr>',loadRecentActivity()}catch(e){console.error("Failed to load website data:",e)}}let activityState={page:1,totalPages:1,sortColumn:"timestamp",sortDirection:"desc"};async function loadRecentActivity(){const e=document.getElementById("activity-body"),t=document.getElementById("activity-date-filter")?.value||"30",n=document.getElementById("activity-action-filter")?.value||"",a=document.getElementById("activity-source-filter")?.value||"",o=document.getElementById("activity-supplier-search")?.value||"",s=new URLSearchParams;s.append("limit","50"),s.append("page",activityState.page),t&&s.append("days",t),n&&s.append("action",n),a&&s.append("pageSource",a),o&&s.append("supplier",o);try{e.innerHTML='<tr><td colspan="5" class="hint">Loading...</td></tr>';const t=await api(`/activity?${s.toString()}`);if(t.summary){document.getElementById("activity-today").textContent=t.summary.today,document.getElementById("activity-week").textContent=t.summary.thisWeek,document.getElementById("activity-calls").textContent=t.summary.callsThisWeek,document.getElementById("activity-websites").textContent=t.summary.websitesThisWeek,document.getElementById("activity-top-supplier").textContent=t.summary.topSupplier||"--";const e=document.getElementById("activity-trend"),n=t.summary.trend;e.textContent=(n>0?"+":"")+n+"%",e.className="summary-value trend-"+t.summary.trendDirection}if(activityState.totalPages=t.totalPages||1,updateActivityPagination(),!t.activity||0===t.activity.length)return void(e.innerHTML='<tr><td colspan="5" class="no-data">No activity found</td></tr>');e.innerHTML="",t.activity.forEach(t=>{const n=document.createElement("tr"),a=new Date(t.timestamp).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}),o={call:"üìû Call",text:"üí¨ Text",email:"‚úâÔ∏è Email",website:"üåê Website",view:"üëÅÔ∏è View",save:"‚≠ê Save",request_quote:"üìã Quote"}[t.action]||t.action,s={prices:"Prices","seo-city":"City","seo-county":"County","seo-state":"State","seo-region":"Region",ios_app:"üì± iOS"}[t.pageSource]||t.pageSource||"--";n.innerHTML=`\n        <td>${a}</td>\n        <td>${t.supplier}${t.supplierLocation?'<br><small class="hint">'+t.supplierLocation+"</small>":""}</td>\n        <td>${o}</td>\n        <td>${t.userZip||"--"}</td>\n        <td>${s}</td>\n      `,e.appendChild(n)})}catch(t){console.error("Failed to load activity:",t),e.innerHTML='<tr><td colspan="5" class="no-data">Failed to load activity</td></tr>'}}function updateActivityPagination(){const e=document.getElementById("activity-prev"),t=document.getElementById("activity-next"),n=document.getElementById("activity-page-info");e&&(e.disabled=activityState.page<=1),t&&(t.disabled=activityState.page>=activityState.totalPages),n&&(n.textContent=`Page ${activityState.page} of ${activityState.totalPages}`)}function initActivityControls(){["activity-date-filter","activity-action-filter","activity-source-filter"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",()=>{activityState.page=1,loadRecentActivity()})});const e=document.getElementById("activity-supplier-search");if(e){let t;e.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{activityState.page=1,loadRecentActivity()},300)})}const t=document.getElementById("activity-prev"),n=document.getElementById("activity-next");t&&t.addEventListener("click",()=>{activityState.page>1&&(activityState.page--,loadRecentActivity())}),n&&n.addEventListener("click",()=>{activityState.page<activityState.totalPages&&(activityState.page++,loadRecentActivity())})}async function loadSupplierSignals(){try{const e=await api(`/clicks?days=${currentDays}`),t=document.getElementById("supplier-signals-body");t.innerHTML="",e.bySupplierWithPrice.slice(0,10).forEach(e=>{const n=document.createElement("tr");n.innerHTML=`\n        <td>${e.name}</td>\n        <td>${e.clicks}</td>\n        <td>${formatPrice(e.currentPrice)}</td>\n        <td>${e.priceDelta?(e.priceDelta>0?"+":"")+formatPrice(e.priceDelta):"--"}</td>\n        <td>${null!==e.estRevenueLost?"$"+e.estRevenueLost:"Unknown"}</td>\n        <td><span class="signal signal-${e.signal}">${formatSignal(e.signal)}</span></td>\n      `,t.appendChild(n)})}catch(e){console.error("Failed to load supplier signals:",e)}}function formatSignal(e){return{brand_strength:"Brand Strength",visibility_issue:"Visibility Gap",data_gap:"Needs Scraping",normal:"Normal"}[e]||e}async function loadClicks(){try{const e=await api(`/clicks?days=${currentDays}`),t=document.getElementById("clicks-chart").getContext("2d");clicksChart&&clicksChart.destroy(),clicksChart=new Chart(t,{type:"line",data:{labels:e.daily.map(e=>e.date),datasets:[{label:"Calls",data:e.daily.map(e=>e.calls),borderColor:"#2563eb",backgroundColor:"rgba(37, 99, 235, 0.1)",fill:!0},{label:"Websites",data:e.daily.map(e=>e.websites),borderColor:"#22c55e",backgroundColor:"rgba(34, 197, 94, 0.1)",fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}});const n=document.getElementById("page-source-chart").getContext("2d");pageSourceChart&&pageSourceChart.destroy(),pageSourceChart=new Chart(n,{type:"doughnut",data:{labels:Object.keys(e.byPage),datasets:[{data:Object.values(e.byPage),backgroundColor:["#2563eb","#22c55e","#f59e0b","#ef4444","#8b5cf6"]}]},options:{responsive:!0,maintainAspectRatio:!1}});const a=document.getElementById("device-chart").getContext("2d");deviceChart&&deviceChart.destroy(),deviceChart=new Chart(a,{type:"doughnut",data:{labels:Object.keys(e.byDevice),datasets:[{data:Object.values(e.byDevice),backgroundColor:["#2563eb","#22c55e"]}]},options:{responsive:!0,maintainAspectRatio:!1}});const o=document.getElementById("clicks-by-supplier-body");o.innerHTML="",e.bySupplier.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n        <td>${e.name}</td>\n        <td>${e.calls}</td>\n        <td>${e.websites}</td>\n        <td>${e.calls+e.websites}</td>\n      `,o.appendChild(t)})}catch(e){console.error("Failed to load clicks:",e)}}async function loadPrices(){try{const e=await api(`/prices?days=${currentDays}`),t=document.getElementById("price-chart").getContext("2d");priceChart&&priceChart.destroy(),priceChart=new Chart(t,{type:"line",data:{labels:e.trends.map(e=>e.date),datasets:[{label:"Avg Price",data:e.trends.map(e=>e.avgPrice),borderColor:"#2563eb",fill:!1},{label:"Min Price",data:e.trends.map(e=>e.minPrice),borderColor:"#22c55e",fill:!1,borderDash:[5,5]},{label:"Max Price",data:e.trends.map(e=>e.maxPrice),borderColor:"#ef4444",fill:!1,borderDash:[5,5]}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!1}}}});const n=document.getElementById("spread-chart").getContext("2d");spreadChart&&spreadChart.destroy(),spreadChart=new Chart(n,{type:"bar",data:{labels:e.priceSpread.map(e=>e.state),datasets:[{label:"Price Spread",data:e.priceSpread.map(e=>e.spread),backgroundColor:"#2563eb"}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{beginAtZero:!0,title:{display:!0,text:"Spread ($)"}}}}});const a=document.getElementById("prices-body");a.innerHTML="",e.bySupplier.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n        <td>${e.name}</td>\n        <td>${e.state}</td>\n        <td>${formatPrice(e.currentPrice)}</td>\n        <td>${timeAgo(e.lastUpdated)}</td>\n      `,a.appendChild(t)})}catch(e){console.error("Failed to load prices:",e)}}async function loadMap(){try{const e=await api(`/geographic?days=${currentDays}`);map||(map=L.map("map-container").setView([40.7,-74],7),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(map)),map.eachLayer(e=>{e instanceof L.CircleMarker&&map.removeLayer(e)});const t=e.demandHeatmap||[],n=Math.max(...t.map(e=>e.count),1);t.forEach(e=>{const t=6+e.count/n*18;L.circleMarker([e.lat,e.lng],{radius:t,fillColor:"#2563eb",color:"#1d4ed8",weight:1,opacity:.8,fillOpacity:.4}).bindPopup(`<b>${e.city||"Unknown"}, ${e.state||""}</b><br>ZIP: ${e.zip}<br>Searches: ${e.count}`).addTo(map)});const a=e.coverageGaps||[];a.forEach(e=>{const t=8+e.count/n*16;L.circleMarker([e.lat,e.lng],{radius:t,fillColor:"#ef4444",color:"#dc2626",weight:2,opacity:1,fillOpacity:.6}).bindPopup(`<b>‚ö†Ô∏è COVERAGE GAP</b><br>${e.city||"Unknown"}, ${e.state||""}<br>ZIP: ${e.zip}<br>Searches: ${e.count}<br><i>No suppliers serve this area!</i>`).addTo(map)});const o=[...t,...a];if(o.length>0){const e=o.map(e=>[e.lat,e.lng]);map.fitBounds(e,{padding:[20,20]})}const s=e.stats||{};document.getElementById("map-stats").innerHTML=`\n      <span class="stat-item"><span class="dot blue"></span> Demand: ${s.totalDemandZips||0} ZIPs</span>\n      <span class="stat-item"><span class="dot red"></span> Coverage Gaps: ${s.totalGapZips||0} ZIPs</span>\n      <span class="stat-item">Supplier Coverage: ${s.coveredZips||0} ZIPs</span>\n    `;const i=document.getElementById("geo-clicks-body");i.innerHTML="";const r=e.allClicks||[];0===r.length?i.innerHTML='<tr><td colspan="5" style="text-align:center">No click data yet</td></tr>':r.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n          <td>${e.zip||"--"}</td>\n          <td>${e.city||"--"}</td>\n          <td>${e.county||"--"}</td>\n          <td>${e.state||"--"}</td>\n          <td>${e.count}</td>\n        `,i.appendChild(t)})}catch(e){console.error("Failed to load map:",e)}}async function loadScrapers(){try{const e=await api("/scraper-health"),t=document.getElementById("last-scrape"),n=document.getElementById("suppliers-scraped");t&&(t.textContent=timeAgo(e.lastRun)),n&&(n.textContent=`${e.withPrices}/${e.totalSuppliers} (${e.suppliersScrapedToday} today)`);const a=document.getElementById("stale-body");if(!a)return;a.innerHTML="",0===e.stale.length?a.innerHTML='<tr><td colspan="5" style="text-align:center">No stale suppliers</td></tr>':(e.stale.forEach(e=>{const t=document.createElement("tr");let n="--";if(e.website&&"string"==typeof e.website){n=`<a href="${e.website.startsWith("http")?e.website:`https://${e.website}`}" target="_blank" rel="noopener noreferrer" class="website-link">${e.website.replace(/^https?:\/\//,"")}</a>`}t.innerHTML=`\n          <td><strong>${e.name}</strong><br><span class="supplier-location">${e.city||""}${e.city&&e.state?", ":""}${e.state||""}</span></td>\n          <td>${formatPrice(e.lastPrice)}</td>\n          <td>${timeAgo(e.lastUpdated)}</td>\n          <td>${n}</td>\n          <td><button class="btn edit-supplier-btn" data-id="${e.id}">Edit</button></td>\n        `,a.appendChild(t)}),a.querySelectorAll(".edit-supplier-btn").forEach(e=>{e.addEventListener("click",()=>editSupplier(e.dataset.id))}))}catch(e){console.error("Failed to load scrapers:",e)}}let suppliersSort="clicks",suppliersOrder="desc";async function loadSuppliers(){try{const e=document.getElementById("filter-state"),t=document.getElementById("filter-price"),n=document.getElementById("filter-scrape"),a=document.getElementById("filter-active"),o=document.getElementById("filter-search"),s=e?.value||"",i=t?.value||"",r=n?.value||"",d=a?.value||"",l=o?.value||"";let c="/suppliers?limit=50&offset="+50*suppliersPage;c+=`&sort=${suppliersSort}&order=${suppliersOrder}`,s&&(c+=`&state=${s}`),i&&(c+=`&hasPrice=${i}`),r&&(c+=`&scrapeStatus=${r}`),d&&(c+=`&active=${d}`),l&&(c+=`&search=${encodeURIComponent(l)}`);const p=await api(c);if(document.querySelectorAll("#suppliers-table th.sortable").forEach(e=>{const t=e.querySelector(".sort-icon");e.dataset.sort===suppliersSort?(t.textContent="asc"===suppliersOrder?"‚Üë":"‚Üì",e.classList.add("sorted")):(t.textContent="‚Üï",e.classList.remove("sorted"))}),e&&1===e.options.length)try{const t=await api("/suppliers?limit=500&offset=0");[...new Set(t.suppliers.map(e=>e.state).filter(Boolean))].sort().forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)})}catch(e){console.warn("Could not load all states:",e)}const u=document.getElementById("results-count");u&&(u.textContent=`Showing ${p.suppliers.length} of ${p.pagination.total} suppliers`);const m=document.getElementById("bulk-actions");m&&m.classList.toggle("hidden",0===p.suppliers.length);const g=document.getElementById("suppliers-body");g.innerHTML="",0===p.suppliers.length?g.innerHTML='<tr><td colspan="6" class="no-data">No suppliers found matching your criteria</td></tr>':(p.suppliers.forEach(e=>{const t=[];e.isActive?t.push('<span class="badge badge-success">Active</span>'):t.push('<span class="badge badge-error">Inactive</span>'),e.scrapingEnabled?t.push('<span class="badge badge-info">Fresh</span>'):e.currentPrice?t.push('<span class="badge badge-warning">Stale</span>'):t.push('<span class="badge badge-muted">No Price</span>');const n=e.recentClicks>10?"üî•":e.recentClicks>0?"üìä":"‚Äî",a=document.createElement("tr");a.className=e.isActive?e.scrapingEnabled?"":"row-stale":"row-inactive";const o=[e.city,e.state].filter(Boolean).join(", ")||"--";let s="";if(e.website&&"string"==typeof e.website){const t=e.website.replace(/^https?:\/\//,"").substring(0,30);s=`<div class="supplier-website"><a href="${e.website.startsWith("http")?e.website:`https://${e.website}`}" target="_blank" rel="noopener noreferrer" class="website-link">${t}</a></div>`}a.innerHTML=`\n          <td>\n            <div class="supplier-name">${e.name}</div>\n            <div class="supplier-meta">${o}</div>\n            ${s}\n          </td>\n          <td class="${e.currentPrice?"price-value":"no-price"}">${formatPrice(e.currentPrice)}</td>\n          <td class="${e.scrapingEnabled?"":"stale-date"}">${timeAgo(e.priceUpdatedAt)}</td>\n          <td class="clicks-cell">${n} ${e.recentClicks}</td>\n          <td class="status-badges">${t.join("")}</td>\n          <td class="actions-cell">\n            <button class="btn-small btn-edit edit-supplier-btn" data-id="${e.id}">Edit</button>\n          </td>\n        `,g.appendChild(a)}),g.querySelectorAll(".edit-supplier-btn").forEach(e=>{e.addEventListener("click",()=>editSupplier(e.dataset.id))}));const y=Math.ceil(p.pagination.total/50);document.getElementById("page-info").textContent=`Page ${suppliersPage+1} of ${y}`,document.getElementById("prev-page").disabled=0===suppliersPage,document.getElementById("next-page").disabled=suppliersPage>=y-1}catch(e){console.error("Failed to load suppliers:",e);const t=document.getElementById("suppliers-body");t&&(t.innerHTML='<tr><td colspan="6" class="error-message">Failed to load suppliers. Please try again.</td></tr>')}}let supplierMap=null,supplierMarkers=[];async function loadSupplierMap(){if(document.getElementById("supplier-map"))try{supplierMap||(supplierMap=L.map("supplier-map").setView([41.2,-73.7],8),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap contributors",maxZoom:18}).addTo(supplierMap)),supplierMarkers.forEach(e=>supplierMap.removeLayer(e)),supplierMarkers=[];const e=await api("/suppliers/map");if(!e.suppliers||0===e.suppliers.length)return void console.log("No supplier locations available");if(e.suppliers.forEach(e=>{if(!e.lat||!e.lng)return;const t=e.active?e.price?"#22c55e":"#f59e0b":"#9ca3af",n=L.circleMarker([e.lat,e.lng],{radius:8,fillColor:t,color:"#fff",weight:2,opacity:1,fillOpacity:.8}),a=e.price?`<span class="supplier-price">$${e.price.toFixed(2)}/gal</span>`:'<span class="supplier-no-price">No price</span>';n.bindPopup(`\n        <strong>${e.name}</strong><br>\n        ${e.city}, ${e.state}<br>\n        ${a}\n      `),n.addTo(supplierMap),supplierMarkers.push(n)}),supplierMarkers.length>0){const e=L.featureGroup(supplierMarkers);supplierMap.fitBounds(e.getBounds().pad(.1))}console.log(`Loaded ${e.mapped} suppliers on map (${e.needsGeocoding} pending geocoding)`)}catch(e){console.error("Failed to load supplier map:",e)}}async function editSupplier(e){if(console.log("[Dashboard] editSupplier called with id:",e),e&&"undefined"!==e&&"null"!==e)try{const t=await api(`/suppliers/${e}`);console.log("[Dashboard] Supplier data received:",t);const n=t.supplier;document.getElementById("edit-supplier-id").value=n.id,document.getElementById("edit-supplier-name").textContent=n.name,document.getElementById("edit-name").value=n.name||"",document.getElementById("edit-phone").value=n.phone||"",document.getElementById("edit-website").value=n.website||"",document.getElementById("edit-state").value=n.state||"",document.getElementById("edit-city").value=n.city||"",document.getElementById("edit-active").checked=n.is_active,document.getElementById("edit-price-display").checked=n.allow_price_display,document.getElementById("edit-scraping").checked=n.scraping_enabled;document.getElementById("edit-price").value=n.current_price?parseFloat(n.current_price).toFixed(2):"",document.getElementById("edit-price-date").value=n.price_updated_at?timeAgo(n.price_updated_at):"Never",document.getElementById("edit-price-source").value=n.price_source||"Not set",document.getElementById("edit-hours-weekday").value=n.hours_weekday||"",document.getElementById("edit-hours-saturday").value=n.hours_saturday||"",document.getElementById("edit-hours-sunday").value=n.hours_sunday||"",document.getElementById("edit-weekend-delivery").value=n.weekend_delivery||"unknown",document.getElementById("edit-emergency-delivery").value=n.emergency_delivery||"unknown",document.getElementById("edit-emergency-phone").value=n.emergency_phone||"",document.getElementById("edit-hours-notes").value=n.hours_notes||"",document.getElementById("edit-hours-verified").checked=!!n.hours_verified_at;const a=t.clickStats;document.getElementById("edit-click-stats").innerHTML=`\n      <div class="stat-item">\n        <div class="stat-value">${a.total||0}</div>\n        <div class="stat-label">Total Clicks</div>\n      </div>\n      <div class="stat-item">\n        <div class="stat-value">${a.last7Days||0}</div>\n        <div class="stat-label">Last 7 Days</div>\n      </div>\n      <div class="stat-item">\n        <div class="stat-value">${a.calls||0}</div>\n        <div class="stat-label">Phone Calls</div>\n      </div>\n      <div class="stat-item">\n        <div class="stat-value">${a.websites||0}</div>\n        <div class="stat-label">Website Visits</div>\n      </div>\n    `,document.getElementById("supplier-modal").classList.remove("hidden")}catch(e){console.error("Failed to load supplier:",e),alert("Failed to load supplier details: "+(e.message||"Unknown error"))}else alert("Invalid supplier ID")}document.getElementById("prev-page").addEventListener("click",()=>{suppliersPage>0&&(suppliersPage--,loadSuppliers())}),document.getElementById("next-page").addEventListener("click",()=>{suppliersPage++,loadSuppliers()}),document.getElementById("filter-apply").addEventListener("click",()=>{suppliersPage=0,loadSuppliers()}),document.getElementById("filter-clear")?.addEventListener("click",()=>{document.getElementById("filter-search").value="",document.getElementById("filter-state").value="",document.getElementById("filter-price").value="",document.getElementById("filter-scrape").value="";const e=document.getElementById("filter-active");e&&(e.value=""),suppliersPage=0,loadSuppliers()}),document.getElementById("filter-search")?.addEventListener("keypress",e=>{"Enter"===e.key&&(suppliersPage=0,loadSuppliers())}),document.getElementById("export-csv")?.addEventListener("click",async()=>{try{const e=document.getElementById("filter-state")?.value||"",t=document.getElementById("filter-price")?.value||"",n=document.getElementById("filter-search")?.value||"";let a="/suppliers?limit=1000&offset=0&format=csv";e&&(a+=`&state=${e}`),t&&(a+=`&hasPrice=${t}`),n&&(a+=`&search=${encodeURIComponent(n)}`);const o=await fetch(`/api/dashboard${a}`,{headers:{Authorization:`Bearer ${authToken}`}}),s=await o.blob(),i=window.URL.createObjectURL(s),r=document.createElement("a");r.href=i,r.download=`suppliers-${(new Date).toISOString().split("T")[0]}.csv`,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(i)}catch(e){console.error("Failed to export CSV:",e),alert("Failed to export CSV")}}),document.querySelectorAll("#suppliers-table th.sortable").forEach(e=>{e.style.cursor="pointer",e.addEventListener("click",()=>{const t=e.dataset.sort;suppliersSort===t?suppliersOrder="asc"===suppliersOrder?"desc":"asc":(suppliersSort=t,suppliersOrder=["clicks","price","updated"].includes(t)?"desc":"asc"),suppliersPage=0,loadSuppliers()})}),window.editSupplier=editSupplier,document.getElementById("cancel-edit").addEventListener("click",()=>{document.getElementById("supplier-modal").classList.add("hidden")}),document.getElementById("supplier-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("edit-supplier-id").value,n=document.getElementById("edit-price").value,a={name:document.getElementById("edit-name").value,phone:document.getElementById("edit-phone").value,website:document.getElementById("edit-website").value,state:document.getElementById("edit-state").value,city:document.getElementById("edit-city").value,is_active:document.getElementById("edit-active").checked,allow_price_display:document.getElementById("edit-price-display").checked,scraping_enabled:document.getElementById("edit-scraping").checked,manual_price:n?parseFloat(n):null,hours_weekday:document.getElementById("edit-hours-weekday").value||null,hours_saturday:document.getElementById("edit-hours-saturday").value||null,hours_sunday:document.getElementById("edit-hours-sunday").value||null,weekend_delivery:document.getElementById("edit-weekend-delivery").value,emergency_delivery:document.getElementById("edit-emergency-delivery").value,emergency_phone:document.getElementById("edit-emergency-phone").value||null,hours_notes:document.getElementById("edit-hours-notes").value||null,hours_verified:document.getElementById("edit-hours-verified").checked};try{await api(`/suppliers/${t}`,{method:"PUT",body:JSON.stringify(a)}),document.getElementById("supplier-modal").classList.add("hidden"),loadSuppliers(),alert("Supplier updated successfully")}catch(e){console.error("Failed to update supplier:",e),alert("Failed to update supplier")}});let searchesChart=null,peakHoursChart=null,iosChart=null;async function loadConversion(){try{const e=await api(`/conversion?days=${currentDays}`);document.getElementById("funnel-searches").textContent=e.funnel.searches.toLocaleString(),document.getElementById("funnel-clicks").textContent=e.funnel.clicks.toLocaleString(),document.getElementById("funnel-rate").textContent=e.funnel.conversionRate+"%";const t=200,n=e.funnel.searches>0?Math.max(30,e.funnel.clicks/e.funnel.searches*t):30;document.getElementById("funnel-clicks-bar").style.width=n+"px"}catch(e){console.error("Failed to load conversion:",e)}}async function loadPriceAlerts(){try{const e=await api("/price-alerts"),t=document.getElementById("price-alerts-panel"),n=document.getElementById("price-alerts-content");e.alerts&&e.alerts.length>0?(t.style.display="block",n.innerHTML=e.alerts.map(e=>`\n        <div class="price-alert-item ${e.direction}">\n          <div>\n            <span class="price-alert-supplier">${e.supplierName}</span>\n            <span style="color: var(--gray-500); margin-left: 0.5rem;">\n              $${e.previousPrice.toFixed(2)} ‚Üí $${e.currentPrice.toFixed(2)}\n            </span>\n          </div>\n          <span class="price-alert-change ${e.direction}">\n            ${"up"===e.direction?"‚Üë":"‚Üì"} ${e.changePercent}%\n          </span>\n        </div>\n      `).join("")):t.style.display="none"}catch(e){console.error("Failed to load price alerts:",e)}}async function loadSearches(){try{const e=await api(`/searches?days=${currentDays}`);document.getElementById("searches-total").textContent=e.summary.totalSearches.toLocaleString(),document.getElementById("searches-avg").textContent=`${e.summary.avgPerDay} avg/day`,document.getElementById("searches-zips").textContent=e.summary.uniqueZips;const t=document.getElementById("searches-chart").getContext("2d");searchesChart&&searchesChart.destroy(),searchesChart=new Chart(t,{type:"line",data:{labels:e.daily.map(e=>e.date),datasets:[{label:"Searches",data:e.daily.map(e=>e.searches),borderColor:"#2563eb",backgroundColor:"rgba(37, 99, 235, 0.1)",fill:!0,tension:.3}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}});const n=document.getElementById("peak-hours-chart").getContext("2d");peakHoursChart&&peakHoursChart.destroy(),peakHoursChart=new Chart(n,{type:"bar",data:{labels:e.hourly.map(e=>`${e.hour}:00`),datasets:[{label:"Searches",data:e.hourly.map(e=>e.searches),backgroundColor:"#2563eb"}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}});const a=document.getElementById("top-zips-body");a.innerHTML="",e.topZips.slice(0,15).forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n        <td>${e.zip}</td>\n        <td>${e.city}</td>\n        <td>${e.state}</td>\n        <td>${e.searches}</td>\n      `,a.appendChild(t)})}catch(e){console.error("Failed to load searches:",e)}}async function loadIOSApp(){try{const e=await api(`/unified?days=${currentDays}`),t=e?.app||{},n=e?.retention||{},a=!0===e?.dataSources?.firebase,o=document.getElementById("ios-firebase-setup");o&&(o.style.display=a?"none":"block");const s=t.uniqueUsers||0;if(document.getElementById("ios-installs").textContent=a&&t.installs||"--",document.getElementById("ios-mau").textContent=s||"--",a&&t.installs&&s){const e=(s/t.installs*100).toFixed(0);document.getElementById("ios-mau-percent").textContent=`${e}% of installs`}else document.getElementById("ios-mau-percent").textContent=s>0?"Active users":"--% of installs";const i=document.getElementById("ios-retention"),r=n?.summary?.week1RetentionRate;r?(i.textContent=`${r}%`,i.classList.toggle("good",parseFloat(r)>=30)):i.textContent="--%",document.getElementById("ios-deliveries").textContent=t.saves||"--",document.getElementById("ios-event-supplier").textContent=t.views||"--",document.getElementById("ios-event-price").textContent="--",document.getElementById("ios-event-search").textContent="--",document.getElementById("ios-event-noresults").textContent="--";let d=null;try{d=await api(`/ios-app?days=${currentDays}`)}catch(e){console.log("Local iOS data not available")}const l=document.getElementById("ios-chart").getContext("2d");iosChart&&iosChart.destroy(),d?.daily?.length>0&&(iosChart=new Chart(l,{type:"line",data:{labels:d.daily.map(e=>e.date),datasets:[{label:"Engagements",data:d.daily.map(e=>e.engagements),borderColor:"#22c55e",backgroundColor:"rgba(34, 197, 94, 0.1)",fill:!0,tension:.3}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}}));const c=document.getElementById("ios-suppliers-body");c.innerHTML="",d?.bySupplier?.length>0?d.bySupplier.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n          <td>${e.name}</td>\n          <td>${e.views}</td>\n          <td>${e.calls}</td>\n          <td>${e.engagements}</td>\n        `,c.appendChild(t)}):c.innerHTML='<tr><td colspan="4" class="no-data">No app engagement data yet</td></tr>'}catch(e){console.error("Failed to load iOS app data:",e)}}async function showCoverageDetails(e){const t=document.getElementById("zip-details-modal"),n=document.getElementById("zip-details-title"),a=document.getElementById("zip-details-content");"no-suppliers"===e?n.textContent="ZIPs With No Supplier Coverage":"low-engagement"===e&&(n.textContent="ZIPs With Low Engagement (No Clicks)"),a.innerHTML="<p>Loading...</p>",t.classList.remove("hidden");try{const t=await api(`/coverage-details?type=${e}&days=${currentDays}`);if(0===t.zips.length)return void(a.innerHTML="<p>No ZIPs found for this category.</p>");let n=`\n      <p style="margin-bottom: 1rem; color: var(--gray-500);">\n        ${t.count} ZIPs found in the last ${t.period}\n      </p>\n      <table>\n        <thead>\n          <tr>\n            <th>ZIP</th>\n            <th>City</th>\n            <th>County</th>\n            <th>State</th>\n            <th>Searches</th>\n          </tr>\n        </thead>\n        <tbody>\n    `;t.zips.forEach(e=>{n+=`\n        <tr>\n          <td>${e.zip}</td>\n          <td>${e.city}</td>\n          <td>${e.county}</td>\n          <td>${e.state}</td>\n          <td>${e.searches}</td>\n        </tr>\n      `}),n+="</tbody></table>",a.innerHTML=n}catch(e){console.error("Failed to load coverage details:",e),a.innerHTML=`<p class="error">Failed to load data: ${e.message}</p>`}}function switchTab(e){const t=document.querySelector(`.tab[data-tab="${e}"]`);t&&t.click()}document.getElementById("close-zip-details").addEventListener("click",()=>{document.getElementById("zip-details-modal").classList.add("hidden")}),document.getElementById("zip-details-modal").addEventListener("click",e=>{"zip-details-modal"===e.target.id&&document.getElementById("zip-details-modal").classList.add("hidden")});let retentionChart=null,trafficSourcesChart=null,acquisitionFunnelChart=null,androidTrendChart=null;async function loadRecommendations(){const e=document.getElementById("recommendations-loading"),t=document.getElementById("recommendations-content"),n=document.getElementById("no-recommendations");e.classList.remove("hidden"),t.classList.add("hidden"),n.classList.add("hidden");try{const e=await api(`/recommendations?days=${currentDays}`),a=e.recommendations.filter(e=>"CRITICAL"===e.priority||"HIGH"===e.priority),o=e.recommendations.filter(e=>"MEDIUM"===e.priority),s=e.recommendations.filter(e=>"LOW"===e.priority||"OPPORTUNITY"===e.priority);if(e.summary.topPriority){document.getElementById("top-priority-alert").classList.remove("hidden"),document.getElementById("priority-title").textContent=e.summary.topPriority.title;const t=e.recommendations[0];document.getElementById("priority-insight").textContent=t?.insight||""}renderRecommendationCards("cards-high",a),renderRecommendationCards("cards-medium",o),renderRecommendationCards("cards-low",s),document.getElementById("section-high").style.display=a.length>0?"block":"none",document.getElementById("section-medium").style.display=o.length>0?"block":"none",document.getElementById("section-low").style.display=s.length>0?"block":"none",0===e.recommendations.length?n.classList.remove("hidden"):t.classList.remove("hidden")}catch(t){console.error("Failed to load recommendations:",t),e.textContent="Failed to load recommendations"}finally{e.classList.add("hidden")}}function renderRecommendationCards(e,t){const n=document.getElementById(e);n.innerHTML="",t.forEach(e=>{const t=document.createElement("div");t.className=`recommendation-card ${e.priority.toLowerCase()}`;const a=e.actions?.map(e=>`<li>${e.text||e}</li>`).join("")||"",o=e.metrics?`\n      <div class="rec-metrics">\n        ${Object.entries(e.metrics).map(([e,t])=>`<span><strong>${e}:</strong> ${"object"==typeof t?JSON.stringify(t):t}</span>`).join(" | ")}\n      </div>\n    `:"";t.innerHTML=`\n      <div class="rec-header">\n        <div class="rec-title">${e.title}</div>\n        <span class="rec-category">${e.category}</span>\n      </div>\n      <div class="rec-insight">${e.insight}</div>\n      <ul class="rec-actions">${a}</ul>\n      ${o}\n    `,n.appendChild(t)})}async function loadRetention(){try{const e=await api(`/unified?days=${currentDays}`),t=e?.cohortRetention||{},n=await api("/retention").catch(()=>null),a=t.available&&t.hasData;if(!a&&!(n?.available&&n?.hasData))return void showRetentionNoData("Retention requires repeat user visits. Data will appear as users return.");if(a&&t.data){const e=t.data.summary||{},n=t.data.cohorts||[],a=t.data.curve||[],o=document.getElementById("day1-retention"),s=document.getElementById("day7-retention"),i=document.getElementById("day30-retention");if(o){const t=parseFloat(e.day1Rate)||0;o.textContent=`${t}%`,o.className="stat-large retention-stat "+(t>=40?"good":t>=20?"warning":"poor")}if(s){const t=parseFloat(e.day7Rate)||0;s.textContent=`${t}%`,s.className="stat-large retention-stat "+(t>=20?"good":t>=10?"warning":"poor")}if(i){const t=parseFloat(e.day30Rate)||0;i.textContent=`${t}%`,i.className="stat-large retention-stat "+(t>=10?"good":t>=5?"warning":"poor")}document.getElementById("cohort-size").textContent=e.totalUsers||"0";const r=document.getElementById("cohort-table-body");if(r&&(r.innerHTML="",n.slice(0,14).forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n            <td>${formatDate(e.date)}</td>\n            <td>${e.size}</td>\n            <td class="rate-cell ${getRateClass(e.day1.rate,40,20)}">${e.day1.rate}%</td>\n            <td class="rate-cell ${getRateClass(e.day7.rate,20,10)}">${e.day7.rate}%</td>\n            <td class="rate-cell ${getRateClass(e.day30.rate,10,5)}">${e.day30.rate}%</td>\n          `,r.appendChild(t)})),a.length>0){const e=document.getElementById("retention-curve-chart");e&&(retentionChart&&retentionChart.destroy(),retentionChart=new Chart(e,{type:"line",data:{labels:a.map(e=>`Day ${e.day}`),datasets:[{label:"Retention %",data:a.map(e=>parseFloat(e.rate)),borderColor:"#2563eb",backgroundColor:"rgba(37, 99, 235, 0.1)",fill:!0,tension:.3}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,max:100,title:{display:!0,text:"Retention %"}},x:{ticks:{maxTicksLimit:10}}}}}))}}if(n?.data?.behaviorRetention){const e=document.getElementById("behavior-retention-body");if(e){e.innerHTML="";const t={made_call:"Users who call stay much longer",saved_supplier:"Saving = investment in app",browsed_only:"Need to drive action",logged_delivery:"High engagement behavior",set_up_tank:"Shows app investment",searched_supplier:"Active user signal"},a=n.data.behaviorRetention||[];0===a.length?e.innerHTML='<tr><td colspan="4" class="no-data">No behavior data available</td></tr>':a.forEach(n=>{const a=document.createElement("tr");a.innerHTML=`\n              <td>${formatBehavior(n.behavior)}</td>\n              <td>${n.userCount}</td>\n              <td>${(n.avgActiveDays||0).toFixed(1)} days</td>\n              <td>${t[n.behavior]||"--"}</td>\n            `,e.appendChild(a)})}}}catch(e){console.error("Failed to load retention:",e),showRetentionNoData("Error loading retention data")}}function getRateClass(e,t,n){const a=parseFloat(e)||0;return a>=t?"rate-good":a>=n?"rate-warning":"rate-poor"}function formatDate(e){if(!e)return"--";return new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric"})}function showRetentionNoData(e){const t=document.getElementById("day1-retention"),n=document.getElementById("day7-retention"),a=document.getElementById("day30-retention");t&&(t.textContent="N/A"),n&&(n.textContent="N/A"),a&&(a.textContent="N/A"),document.getElementById("cohort-size").textContent="0";const o=document.getElementById("cohort-table-body");o&&(o.innerHTML=`<tr><td colspan="5" class="no-data">${e}</td></tr>`);const s=document.getElementById("behavior-retention-body");s&&(s.innerHTML=`\n      <tr><td colspan="4" class="no-data">\n        <div class="no-data-message">\n          <p><strong>No retention data available</strong></p>\n          <p class="hint">${e}</p>\n          <p class="hint">Retention tracking requires user engagement data.</p>\n        </div>\n      </td></tr>\n    `)}function formatBehavior(e){return{made_call:"Made a Call",saved_supplier:"Saved a Supplier",browsed_only:"Browsed Only",logged_delivery:"Logged Delivery",set_up_tank:"Set Up Tank",searched_supplier:"Searched Suppliers"}[e]||e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}async function loadAcquisition(){try{const e=await api(`/acquisition?days=${currentDays}`);if(!e.available)return void console.log("Acquisition data not available:",e.reason);e.data?.websiteTraffic?(document.getElementById("acq-sessions").textContent=e.data.websiteTraffic.sessions||"--",document.getElementById("acq-organic").textContent=`${e.data.websiteTraffic.organicPercent||0}%`):document.getElementById("acq-sessions-source").textContent="GA4 not configured";const t=e.data?.conversionFunnel?.daily||[];if(t.length>0){const e=t.reduce((e,t)=>e+t.searches,0),n=t.reduce((e,t)=>e+t.clicks,0),a=e>0?(n/e*100).toFixed(1):0;document.getElementById("acq-conversion").textContent=`${a}%`}if(e.data?.websiteTraffic?.trafficSources){const t=e.data.websiteTraffic.trafficSources,n=document.getElementById("traffic-sources-chart").getContext("2d");trafficSourcesChart&&trafficSourcesChart.destroy(),trafficSourcesChart=new Chart(n,{type:"bar",data:{labels:t.map(e=>e.channel),datasets:[{label:"Sessions",data:t.map(e=>e.sessions),backgroundColor:"#2563eb"}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y"}})}else document.getElementById("traffic-sources-note").textContent="Configure GA4 API to see traffic sources";if(t.length>0){const e=document.getElementById("acquisition-funnel-chart").getContext("2d");acquisitionFunnelChart&&acquisitionFunnelChart.destroy(),acquisitionFunnelChart=new Chart(e,{type:"line",data:{labels:t.map(e=>e.date),datasets:[{label:"Searches",data:t.map(e=>e.searches),borderColor:"#2563eb",fill:!1},{label:"Clicks",data:t.map(e=>e.clicks),borderColor:"#22c55e",fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}})}const n=document.getElementById("converting-locations-body");n.innerHTML="",(e.data?.topConvertingLocations||[]).slice(0,15).forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n        <td>${e.zip}</td>\n        <td>${e.city}</td>\n        <td>${e.searches}</td>\n        <td>${e.clicks}</td>\n        <td>${e.conversionRate}%</td>\n      `,n.appendChild(t)})}catch(e){console.error("Failed to load acquisition:",e)}}async function loadAndroidSignals(){try{const e=(await api("/unified?days=30")).android;if(!e)return void console.log("Android signals not available");const t=document.getElementById("android-status");t.textContent=e.recommendation?.status||"WAIT",t.className="decision-status "+(e.recommendation?.status||"wait").toLowerCase(),document.getElementById("android-message").textContent=e.recommendation?.message||"Loading...",document.getElementById("android-waitlist").textContent=e.waitlist?.total??"--",document.getElementById("android-growth").textContent=`${e.waitlist?.growthRate??0}%`,document.getElementById("android-pwa").textContent=e.pwa?.installs??"--";const n=e.pwa?.conversionRate,a=document.getElementById("android-pwa-rate");a&&(a.textContent=n?`${n}% conversion`:"--% conversion");const o=document.getElementById("pwa-prompts"),s=document.getElementById("pwa-installs-detail"),i=document.getElementById("pwa-launches");o&&(o.textContent=e.pwa?.prompts??"--"),s&&(s.textContent=e.pwa?.installs??"--"),i&&(i.textContent=e.pwa?.launches??"--");const r=document.getElementById("thresholds-grid");if(r.innerHTML="",e.thresholds&&Object.entries(e.thresholds).forEach(([e,t])=>{const n=document.createElement("div");n.className="threshold-item",n.innerHTML=`\n          <div class="threshold-icon">${t.met?"‚úÖ":"‚è≥"}</div>\n          <div class="threshold-content">\n            <div class="threshold-label">${formatThresholdKey(e)}</div>\n            <div class="threshold-value">${t.current}</div>\n            <div class="threshold-target">Target: ${t.value}</div>\n          </div>\n        `,r.appendChild(n)}),e.platformBreakdown){const t=e.platformBreakdown;document.getElementById("platform-ios").textContent=`${t.ios?.percent||0}%`,document.getElementById("platform-ios-users").textContent=`${t.ios?.users||0} users`,document.getElementById("platform-android").textContent=`${t.android?.percent||0}%`,document.getElementById("platform-android-users").textContent=`${t.android?.users||0} users`,document.getElementById("platform-desktop").textContent=`${t.desktop?.percent||0}%`,document.getElementById("platform-desktop-users").textContent=`${t.desktop?.users||0} users`,document.getElementById("platform-note").textContent=""}else document.getElementById("platform-note").textContent="GA4 not configured - enable for platform data";document.getElementById("weeks-to-200").textContent=e.projection?.weeksTo200||"N/A",document.getElementById("expected-users").textContent=e.projection?.expectedConversion||"--";const d=e.weeklyTrend||[];if(d.length>0){const e=document.getElementById("android-trend-chart").getContext("2d");androidTrendChart&&androidTrendChart.destroy(),androidTrendChart=new Chart(e,{type:"line",data:{labels:d.map(e=>new Date(e.week).toLocaleDateString("en-US",{month:"short",day:"numeric"})),datasets:[{label:"Weekly Signups",data:d.map(e=>e.signups),borderColor:"#8b5cf6",backgroundColor:"rgba(139, 92, 246, 0.1)",fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}})}}catch(e){console.error("Failed to load Android signals:",e)}}function formatThresholdKey(e){return{waitlist:"Waitlist Size",growthRate:"Weekly Growth",pwaAdoption:"PWA Installs"}[e]||e}async function loadLeaderboard(){const e=document.getElementById("leaderboard-loading"),t=document.getElementById("leaderboard-content");e.classList.remove("hidden"),t.classList.add("hidden");try{const e=(await api(`/unified?days=${currentDays}`)).topSuppliers||[],n=e.reduce((e,t)=>e+(t.calls||0),0),a=e.reduce((e,t)=>e+(t.websiteClicks||0),0),o=(e.reduce((e,t)=>e+(t.fromWeb||0),0),e.reduce((e,t)=>e+(t.fromApp||0),0),e.reduce((e,t)=>e+(t.totalClicks||0),0)),s=e.length>0&&e[0].marketAvg?e[0].marketAvg:0,i=e.slice(0,3).reduce((e,t)=>e+(t.totalClicks||0),0),r=o>0?(i/o*100).toFixed(0):0;document.getElementById("lb-total-suppliers").textContent=e.length,document.getElementById("lb-total-clicks").textContent=`${o} (üìû${n} + üîó${a})`,document.getElementById("lb-market-avg").textContent=s>0?formatPrice(s):"--",document.getElementById("lb-top3-pct").textContent=`${r}%`;const d=document.getElementById("quick-wins-list");d.innerHTML="";const l=e.filter(e=>"data_gap"===e.signal).slice(0,3),c=e.filter(e=>"visibility_issue"===e.signal).slice(0,3);l.length>0&&(d.innerHTML+=`<div class="quick-win">‚ö†Ô∏è <strong>${l.length} suppliers</strong> getting clicks but no price data - add scraping</div>`),c.length>0&&(d.innerHTML+=`<div class="quick-win">üëÄ <strong>${c.length} suppliers</strong> have competitive prices but low visibility</div>`),0===l.length&&0===c.length&&(d.innerHTML='<div class="quick-win success">‚úÖ No urgent issues detected</div>');const p=document.getElementById("leaderboard-body");p.innerHTML="",0===e.length?p.innerHTML='<tr><td colspan="12" style="text-align:center;color:var(--gray-500);padding:2rem;">No engagement data for this period</td></tr>':e.forEach(e=>{const t=null!=e.priceDelta?(e.priceDelta>0?"+":"")+formatPrice(e.priceDelta):"--",n={brand_strength:'<span class="signal brand">üí™ Brand</span>',visibility_issue:'<span class="signal visibility">üëÄ Hidden</span>',data_gap:'<span class="signal data-gap">‚ö†Ô∏è No Price</span>',normal:'<span class="signal normal">‚Äî</span>'},a=document.createElement("tr");a.innerHTML=`\n          <td class="rank">${e.rank}</td>\n          <td>${e.name}</td>\n          <td>${e.location||"--"}</td>\n          <td class="users-col">${e.uniqueUsers??"--"}</td>\n          <td>${e.calls>0?e.calls:"-"}</td>\n          <td>${e.websiteClicks>0?e.websiteClicks:"-"}</td>\n          <td class="total-col">${e.totalClicks}</td>\n          <td class="web-col">${e.fromWeb>0?e.fromWeb:"-"}</td>\n          <td class="app-col">${e.fromApp>0?e.fromApp:"-"}</td>\n          <td>${e.price?formatPrice(e.price):"--"}</td>\n          <td class="${e.priceDelta>0?"above-market":e.priceDelta<0?"below-market":""}">${t}</td>\n          <td>${n[e.signal]||n.normal}</td>\n        `,p.appendChild(a)}),document.getElementById("lb-export-csv").onclick=()=>{const t=["Rank,Supplier,Location,Unique Users,Calls,Site Clicks,Total,From Web,From App,Price,vs Market,Signal"];e.forEach(e=>{t.push(`${e.rank},"${e.name}","${e.location||""}",${e.uniqueUsers||0},${e.calls||0},${e.websiteClicks||0},${e.totalClicks||0},${e.fromWeb||0},${e.fromApp||0},${e.price||""},${e.priceDelta||""},${e.signal||""}`)});const n=new Blob([t.join("\n")],{type:"text/csv"}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=`leaderboard-${(new Date).toISOString().split("T")[0]}.csv`,o.click()},t.classList.remove("hidden")}catch(t){console.error("Failed to load leaderboard:",t),e.textContent="Failed to load leaderboard"}finally{e.classList.add("hidden")}}let dauChart=null;function renderDAUChart(e){const t=document.getElementById("dau-chart");if(!t)return;const n=t.getContext("2d");dauChart&&dauChart.destroy();const a=e=>{if(!e)return new Date(NaN);const t=String(e);return 8===t.length&&/^\d{8}$/.test(t)?new Date(`${t.slice(0,4)}-${t.slice(4,6)}-${t.slice(6,8)}`):new Date(e)},o=[...e].sort((e,t)=>a(e.date)-a(t.date)),s=o.map(e=>a(e.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})),i=o.map(e=>e.users);dauChart=new Chart(n,{type:"line",data:{labels:s,datasets:[{label:"Daily Active Users",data:i,borderColor:"#3b82f6",backgroundColor:"rgba(59, 130, 246, 0.1)",borderWidth:2,fill:!0,tension:.3,pointRadius:3,pointBackgroundColor:"#3b82f6",pointHoverRadius:5}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{mode:"index",intersect:!1,callbacks:{label:function(e){return`${e.parsed.y} users`}}}},scales:{x:{grid:{display:!1}},y:{beginAtZero:!0,ticks:{stepSize:1,callback:function(e){if(Number.isInteger(e))return e}}}},interaction:{mode:"nearest",axis:"x",intersect:!1}}})}async function loadAppAnalytics(){const e=document.getElementById("app-analytics-loading"),t=document.getElementById("app-analytics-content"),n=document.getElementById("app-data-source"),a=document.getElementById("legacy-engagement");e.classList.remove("hidden"),t.classList.add("hidden"),n?.classList.add("hidden");try{const[e,o]=await Promise.all([api(`/unified?days=${currentDays}`).catch(()=>null),api(`/ios-app?days=${currentDays}`).catch(()=>null)]),s=e?.app||{},i="bigquery"===(e?.appSource||"none");if(n&&i&&n.classList.remove("hidden"),a&&a.classList.toggle("hidden",i),i&&s.summary){const e=s.summary,t=s.retention||{},n=s.dailyActiveUsers||[],a=s.topEvents||[],i=s.topScreens||[];if(document.getElementById("aa-users").textContent=e.totalUsers||"--",document.getElementById("aa-users-sub").textContent=`${currentDays}d period`,document.getElementById("aa-sessions").textContent=e.totalSessions||"--",document.getElementById("aa-sessions-sub").textContent=e.avgSessionDuration?`Avg ${e.avgSessionDuration}s`:"--",document.getElementById("aa-day1").textContent=t.day1Rate?`${t.day1Rate}%`:"--%",document.getElementById("aa-day1-sub").textContent=t.day1?`${t.day1} of ${t.newUsers} retained`:"--",document.getElementById("aa-day7").textContent=t.day7Rate?`${t.day7Rate}%`:"--%",document.getElementById("aa-day7-sub").textContent=t.day7?`${t.day7} of ${t.newUsers} retained`:"--",n.length>0){renderDAUChart(n);const e=Math.round(n.reduce((e,t)=>e+t.users,0)/n.length),t=Math.max(...n.map(e=>e.users));document.getElementById("dau-avg").textContent=e,document.getElementById("dau-peak").textContent=t}const r=o?.onboardingFunnel;let d;if(r&&r.steps)d=r;else if(a.length>0){const e=e=>a.find(t=>t.name===e)?.uniqueUsers||0,t=e("first_open"),n=e("onboarding_step"),o=e("directory_viewed"),s=e("forecast_viewed"),i=e("tank_reading"),r=Math.max(o,s,i);d={steps:[{name:"Install",count:t,percent:100},{name:"Start Onboarding",count:n,percent:t>0?Math.round(n/t*100):0},{name:"Complete Onboarding",count:n,percent:t>0?Math.round(n/t*100):0},{name:"First Value Action",count:r,percent:t>0?Math.round(r/t*100):0}],summary:{installs:t,onboardingRate:t>0?(n/t*100).toFixed(1):0,activationRate:t>0?(r/t*100).toFixed(1):0}}}if(d&&d.steps){const e=d.steps;document.getElementById("funnel-install-count").textContent=e[0]?.count??0,document.getElementById("funnel-install-pct").textContent="100%",document.getElementById("funnel-install").style.width="100%",document.getElementById("funnel-onboard-count").textContent=e[1]?.count??0,document.getElementById("funnel-onboard-pct").textContent=`${e[1]?.percent??0}%`,document.getElementById("funnel-onboard").style.width=`${Math.max(e[1]?.percent??0,5)}%`,document.getElementById("funnel-complete-count").textContent=e[2]?.count??0,document.getElementById("funnel-complete-pct").textContent=`${e[2]?.percent??0}%`,document.getElementById("funnel-complete").style.width=`${Math.max(e[2]?.percent??0,5)}%`,document.getElementById("funnel-fva-count").textContent=e[3]?.count??0,document.getElementById("funnel-fva-pct").textContent=`${e[3]?.percent??0}%`,document.getElementById("funnel-fva").style.width=`${Math.max(e[3]?.percent??0,5)}%`;const t=parseFloat(d.summary?.onboardingRate)||0,n=parseFloat(d.summary?.activationRate)||0,a=document.getElementById("funnel-insight");a.textContent=t<20?`üí° Only ${t}% complete onboarding - consider simplifying the flow`:n<30?`üí° ${n}% reach first value action - improve time-to-value`:`üí° ${n}% activation rate - healthy user funnel!`}const l=document.getElementById("top-events-body");l&&(l.innerHTML=a.length>0?a.slice(0,10).map(e=>`\n              <tr>\n                <td><span class="event-name">${e.name}</span></td>\n                <td class="count-cell">${e.count.toLocaleString()}</td>\n                <td>${e.uniqueUsers}</td>\n              </tr>\n            `).join(""):'<tr><td colspan="3" class="no-data">No events recorded</td></tr>');const c=document.getElementById("top-screens-body");c&&(c.innerHTML=i.length>0?i.slice(0,10).map(e=>`\n              <tr>\n                <td>${e.name||"Unknown"}</td>\n                <td class="count-cell">${e.views.toLocaleString()}</td>\n                <td>${e.uniqueUsers}</td>\n              </tr>\n            `).join(""):'<tr><td colspan="3" class="no-data">No screen views recorded</td></tr>')}else{const e=o?.engagement||{},t=s.sessions||s.totalEngagements||e.totalSessions||0;document.getElementById("aa-sessions").textContent=t||"--",document.getElementById("aa-sessions-sub").textContent=t>0?`${currentDays}d period`:"No data",document.getElementById("aa-users").textContent=s.uniqueUsers||"--",document.getElementById("aa-users-sub").textContent="From database",document.getElementById("aa-day1").textContent="--%",document.getElementById("aa-day1-sub").textContent="BigQuery required",document.getElementById("aa-day7").textContent="--%",document.getElementById("aa-day7-sub").textContent="BigQuery required";const n=e.powerUsers||0,a=e.engaged||0,i=e.casual||0,r=e.browseOnly||100-n-a-i;document.getElementById("aa-power").textContent=`${n}%`,document.getElementById("aa-engaged").textContent=`${a}%`,document.getElementById("aa-browse").textContent=`${r}%`,document.getElementById("bar-power").style.width=`${n}%`,document.getElementById("bar-power-val").textContent=`${n}%`,document.getElementById("bar-engaged").style.width=`${a}%`,document.getElementById("bar-engaged-val").textContent=`${a}%`,document.getElementById("bar-casual").style.width=`${i}%`,document.getElementById("bar-casual-val").textContent=`${i}%`,document.getElementById("bar-browse").style.width=`${r}%`,document.getElementById("bar-browse-val").textContent=`${r}%`,document.getElementById("top-events-body").innerHTML='<tr><td colspan="3" class="no-data">BigQuery not configured</td></tr>',document.getElementById("top-screens-body").innerHTML='<tr><td colspan="3" class="no-data">BigQuery not configured</td></tr>'}const r=e?.app||{},d=r.deliveries||{},l=d.total||0;document.getElementById("dp-total").textContent=l||"0",document.getElementById("dp-value").textContent=l>0?`~$${(500*l).toLocaleString()}`:"$0",document.getElementById("dp-repeat").textContent=d.repeatRate||"0%",document.getElementById("dp-directory").textContent=d.fromDirectory||"0%",document.getElementById("dp-ontime").textContent=d.onTime||"0%",document.getElementById("dp-late").textContent=d.late||"0%",document.getElementById("dp-overdue").textContent=d.overdue||"0",document.getElementById("dp-insight").textContent=l>0?"üí° Users who log deliveries have higher retention":"üí° Encourage first delivery logging to boost retention";const c=r.fve||{};document.getElementById("fve-rate").textContent=c.completionRate||"--%",document.getElementById("fve-72h").textContent=c.within72h||"--%",document.getElementById("fve-retention").textContent=c.userRetention||"--%",document.getElementById("fve-non-retention").textContent=c.nonUserRetention||"--%",document.getElementById("fve-multiplier").textContent=c.multiplier||"--√ó",document.getElementById("fve-insight").textContent=c.completionRate&&"--%"!==c.completionRate?"üí° Users who complete FVE retain significantly better":"üí° Track first value events to measure user activation";const p=r.confidence||{};document.getElementById("cs-avg").textContent=p.avg||"--",document.getElementById("cs-high-bar").style.width=`${p.highPct||0}%`,document.getElementById("cs-med-bar").style.width=`${p.medPct||0}%`,document.getElementById("cs-low-bar").style.width=`${p.lowPct||0}%`,document.getElementById("cs-high-pct").textContent=`${p.highPct||0}%`,document.getElementById("cs-med-pct").textContent=`${p.medPct||0}%`,document.getElementById("cs-low-pct").textContent=`${p.lowPct||0}%`;const u=document.getElementById("confidence-factors");u.innerHTML="",p.factors&&Object.entries(p.factors).forEach(([e,t])=>{u.innerHTML+=`<div class="factor"><span>${e}</span><span>${t}</span></div>`}),document.getElementById("cs-insight").textContent=p.avg&&"--"!==p.avg?"üí° Higher confidence = more likely to order through app":"üí° Confidence builds as users engage more";const m=r.fuelType||{};document.getElementById("fuel-oil-users").textContent=`${m.oil?.users??"--"} users`,document.getElementById("fuel-oil-pct").textContent=`${m.oil?.pct??"--"}%`,document.getElementById("fuel-propane-users").textContent=`${m.propane?.users??"--"} users`,document.getElementById("fuel-propane-pct").textContent=`${m.propane?.pct??"--"}%`;document.getElementById("propane-signal-list").innerHTML=m.propane?.users>0?`<div class="signal-item">üìä ${m.propane.users} propane users tracked - expansion opportunity</div>`:'<div class="signal-item hint">No propane demand signals yet</div>';const g=e?.correlations||{},y=g.price||{},h=document.getElementById("price-corr-value"),b=document.getElementById("price-corr-marker"),v=document.getElementById("price-corr-insight");if(null!==y.correlation&&void 0!==y.correlation){h.textContent=y.correlation.toFixed(2);const e=(y.correlation+1)/2*100;b.style.left=`${e}%`,y.correlation<-.3?h.style.color="#22c55e":y.correlation>.3?h.style.color="#ef4444":h.style.color="var(--gray-600)"}else h.textContent="--";v.textContent=y.insight||"No correlation data available";const f=g.weather||{},E=document.getElementById("weather-temp"),C=document.getElementById("weather-conditions"),I=document.getElementById("weather-insight");if(f.available&&f.currentTemp?(E.textContent=`${f.currentTemp}¬∞F`,C.textContent=f.conditions||"--",I.textContent=f.insight||"Weather data loaded"):(E.textContent="--¬∞F",C.textContent=f.message||"Weather API not configured",I.textContent=f.message||"Set OPENWEATHER_API_KEY to enable weather correlation"),y.dailyData&&y.dailyData.length>0){const e=f.dailyData||[];renderCorrelationChart(y.dailyData.map(t=>{const n=e.find(e=>e.date===t.date);return{...t,temperature:n?.temperature||null}}))}t.classList.remove("hidden")}catch(t){console.error("Failed to load app analytics:",t),e.textContent="Failed to load app analytics"}finally{e.classList.add("hidden")}}let correlationChart=null;function renderCorrelationChart(e){const t=document.getElementById("correlation-chart");if(!t)return;const n=t.getContext("2d");correlationChart&&correlationChart.destroy();const a=e.map(e=>new Date(e.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})),o=e.map(e=>e.avgPrice?parseFloat(e.avgPrice):null),s=e.map(e=>e.totalClicks||0),i=e.map(e=>e.uniqueUsers||0),r=e.map(e=>e.temperature||null),d=r.some(e=>null!==e),l=[{label:"Avg Price ($)",data:o,borderColor:"#22c55e",backgroundColor:"rgba(34, 197, 94, 0.1)",yAxisID:"y-price",tension:.3,pointRadius:2},{label:"Daily Clicks",data:s,borderColor:"#3b82f6",backgroundColor:"rgba(59, 130, 246, 0.1)",yAxisID:"y-clicks",tension:.3,pointRadius:2},{label:"Unique Users",data:i,borderColor:"#8b5cf6",backgroundColor:"rgba(139, 92, 246, 0.1)",yAxisID:"y-clicks",tension:.3,pointRadius:2,borderDash:[3,3]}];d&&l.push({label:"Temperature (¬∞F)",data:r,borderColor:"#f97316",backgroundColor:"rgba(249, 115, 22, 0.1)",yAxisID:"y-temp",tension:.3,pointRadius:2,borderDash:[5,5]});const c={"y-price":{type:"linear",position:"left",title:{display:!0,text:"Price ($)",color:"#22c55e"},grid:{display:!1},ticks:{color:"#22c55e"}},"y-clicks":{type:"linear",position:"right",title:{display:!0,text:"Clicks",color:"#3b82f6"},grid:{drawOnChartArea:!1},ticks:{color:"#3b82f6"}}};d&&(c["y-temp"]={type:"linear",position:"right",title:{display:!0,text:"Temp (¬∞F)",color:"#f97316"},grid:{display:!1},ticks:{color:"#f97316"},offset:!0}),correlationChart=new Chart(n,{type:"line",data:{labels:a,datasets:l},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},scales:c,plugins:{legend:{display:!0,position:"bottom",labels:{usePointStyle:!0,padding:20}},tooltip:{callbacks:{label:e=>"Avg Price ($)"===e.dataset.label?`Price: $${e.raw?.toFixed(2)||"--"}`:"Temperature (¬∞F)"===e.dataset.label?`Temp: ${e.raw?.toFixed(0)||"--"}¬∞F`:"Unique Users"===e.dataset.label?`Users: ${e.raw||0}`:`Clicks: ${e.raw||0}`}}}}})}async function loadGrowth(){const e=document.getElementById("growth-loading"),t=document.getElementById("growth-content");e.classList.remove("hidden"),t.classList.add("hidden");try{const[e,n,a]=await Promise.all([api(`/unified?days=${currentDays}`),api("/retention").catch(()=>({available:!1})),api(`/recommendations?days=${currentDays}`).catch(()=>({recommendations:[]}))]),o=e?.app||{},s=e?.android||{},i=e?.website||{};console.log("[Growth] Website data from unified API:",i),console.log("[Growth] totalClicks:",i.totalClicks,"callClicks:",i.callClicks,"activeUsers:",i.activeUsers);const r=o.summary?.totalUsers||o.uniqueUsers||0,d=o.deliveries?.total||o.saves||0;document.getElementById("p-ios-users").textContent=r??"--",document.getElementById("p-ios-deliveries").textContent=d??"--",document.getElementById("p-ios-retention").textContent=n?.data?.summary?.week1RetentionRate?`${n.data.summary.week1RetentionRate}%`:"--%",document.getElementById("p-android-status").textContent=s?.recommendation?.status||"WAIT",document.getElementById("p-android-waitlist").textContent=s?.waitlist?.total??"--",document.getElementById("p-android-pwa").textContent=s?.pwa?.installs??"--",document.getElementById("p-android-launches").textContent=s?.pwa?.launches??"--",document.getElementById("p-web-visitors").textContent=i.activeUsers||i.users||"--",document.getElementById("p-web-clicks").textContent=i.totalClicks??"--",document.getElementById("p-web-calls").textContent=i.callClicks??"--";const l=document.getElementById("platform-insight");if(r>0&&i.activeUsers>0){const e=r/(r+i.activeUsers)*100;l.textContent=`üí° iOS represents ${e.toFixed(0)}% of active users`}else l.textContent="üí° Track both platforms to compare engagement";const c=s?.waitlist?.total||0,p=s?.pwa?.installs||0,u=parseFloat(n?.data?.summary?.week1RetentionRate)||0,m=document.getElementById("android-badge"),g=document.getElementById("android-message"),y=u<20&&u>0;c>=200&&p>=50&&u>=20?(m.textContent="GO",m.className="decision-badge go",g.textContent="All conditions met - Android development recommended"):y?(m.textContent="NO-GO",m.className="decision-badge nogo",g.textContent="Fix iOS retention first - don't scale a leaky bucket"):(m.textContent="WAIT",m.className="decision-badge wait",g.textContent="Monitor thresholds - continue with PWA"),updateCondition("cond-waitlist",c>=200,`${c}/200`),updateCondition("cond-pwa",p>=50,`${p}/50`),updateCondition("cond-retention",u>=20,`${u}%`);const h={};(n?.data?.behaviorRetention||[]).forEach(e=>{h[e.behavior]=e.avgActiveDays});const b=Math.max(...Object.values(h),1);setRetentionBar("rba-delivery",h.logged_delivery,b),setRetentionBar("rba-tank",h.set_up_tank,b),setRetentionBar("rba-search",h.searched_supplier,b),setRetentionBar("rba-browse",h.browsed_only,b);const v=e?.userJourney||{};v.available&&v.hasData?renderUserJourney(v):document.getElementById("journey-insight").textContent="üí° User journey data will appear once you have visitor and engagement activity.";const f=a.recommendations?.[0];if(f){document.getElementById("rec-title").textContent=f.title,document.getElementById("rec-insight").textContent=f.insight||"";const e=document.getElementById("rec-secondary-list");e.innerHTML="",a.recommendations.slice(1,4).forEach(t=>{e.innerHTML+=`<li>${t.title}</li>`})}else document.getElementById("rec-title").textContent="All systems healthy",document.getElementById("rec-insight").textContent="No urgent recommendations";t.classList.remove("hidden")}catch(t){console.error("Failed to load growth:",t),e.textContent="Failed to load growth data"}finally{e.classList.add("hidden")}}function updateCondition(e,t,n){const a=document.getElementById(e);a&&(a.querySelector(".cond-check").textContent=t?"‚úÖ":"‚è≥",a.querySelector(".cond-value").textContent=n,a.classList.toggle("met",t))}function setRetentionBar(e,t,n){const a=document.getElementById(e),o=document.getElementById(e+"-val");if(a&&o)if(void 0!==t){const e=t/n*100;a.style.width=`${e}%`,o.textContent=`${t.toFixed(1)} days`}else a.style.width="0%",o.textContent="--"}function renderUserJourney(e){const t=e.web||{},n=e.app||{},a=(e,t)=>{const n=document.getElementById(e);n&&(n.textContent=t)},o=(e,t,n)=>{const a=document.getElementById(e);a&&(a.style.width=`${Math.max(8,t/n*100)}%`)};if(t.steps&&t.steps.length>0){const e=t.steps,n=Math.max(...e.map(e=>e.users||0),1);a("wj-visits",e[0]?.users?.toLocaleString()||"--"),o("wj-visits-bar",e[0]?.users||0,n),a("wj-drop-1",e[1]?.dropoff||"--%"),a("wj-views",e[1]?.users?.toLocaleString()||"--"),a("wj-views-rate",e[1]?.rate||"--%"),o("wj-views-bar",e[1]?.users||0,n),a("wj-drop-2",e[2]?.dropoff||"--%"),a("wj-clicks",e[2]?.users?.toLocaleString()||"--"),a("wj-clicks-rate",e[2]?.rate||"--%"),a("wj-calls",e[2]?.breakdown?.call?.toLocaleString()||"0"),a("wj-websites",e[2]?.breakdown?.website?.toLocaleString()||"0"),o("wj-clicks-bar",e[2]?.users||0,n),a("wj-drop-3",e[3]?.dropoff||"--%"),a("wj-deliveries",e[3]?.users?.toLocaleString()||"--"),a("wj-deliveries-rate",e[3]?.rate||"--%");const s=e[3]?.breakdown?.ios??0,i=e[3]?.breakdown?.pwa??0;a("wj-ios",s.toLocaleString()),a("wj-pwa",i.toLocaleString()),o("wj-deliveries-bar",e[3]?.users||0,n),a("wj-overall",t.overallConversion||"--%")}if(n.steps&&n.steps.length>0){const e=n.steps,t=Math.max(...e.map(e=>e.users||0),1);a("aj-opens",e[0]?.users?.toLocaleString()||"--"),o("aj-opens-bar",e[0]?.users||0,t),a("aj-drop-1",e[1]?.dropoff||"--%"),a("aj-searches",e[1]?.users?.toLocaleString()||"--"),a("aj-searches-rate",e[1]?.rate||"--%"),o("aj-searches-bar",e[1]?.users||0,t),a("aj-drop-2",e[2]?.dropoff||"--%"),a("aj-saves",e[2]?.users?.toLocaleString()||"--"),a("aj-saves-rate",e[2]?.rate||"--%"),o("aj-saves-bar",e[2]?.users||0,t),a("aj-drop-3",e[3]?.dropoff||"--%"),a("aj-deliveries",e[3]?.users?.toLocaleString()||"--"),a("aj-deliveries-rate",e[3]?.rate||"--%"),o("aj-deliveries-bar",e[3]?.users||0,t),a("aj-overall",n.overallConversion||"--%")}const s=[];if(t.biggestDropoff&&parseFloat(t.biggestDropoff.rate)>50){const e=t.biggestDropoff.to,n={engaged:"engaging (bounce rate)",contact:"contacting supplier",install:"installing app"}[e]||e;s.push(`Web: ${t.biggestDropoff.rate} drop-off before ${n}`)}if(n.biggestDropoff&&parseFloat(n.biggestDropoff.rate)>50){const e=n.biggestDropoff.to,t={search:"searching directory",save:"saving a supplier",delivery:"logging deliveries"}[e]||e;s.push(`App: ${n.biggestDropoff.rate} drop-off before ${t}`)}const i=parseFloat(t.overallConversion)||0,r=parseFloat(n.overallConversion)||0;(i>0||r>0)&&(i>r&&i>.5?s.push(`Website converts ${i.toFixed(2)}% - better than app`):r>i&&r>.5&&s.push(`App converts ${r.toFixed(2)}% - better than web`));const d=document.getElementById("journey-insight");s.length>0?d.innerHTML="üí° "+s.join(" | "):d.textContent="üí° Track more user activity to see conversion insights."}let coverageData={geographic:null,geoHeatmap:null,overview:null},currentMapView="engagement";async function loadCoverage(){try{const[e,t,n]=await Promise.all([api(`/overview?days=${currentDays}`),api(`/geographic?days=${currentDays}`),api(`/unified?days=${currentDays}`)]);coverageData={geographic:t,geoHeatmap:n?.geoHeatmap?.data||null,overview:e};const a=n?.geoHeatmap||{},o=a?.data?.summary||{},s=a?.data?.stateBreakdown||[],i=a?.data?.topLocations||[];console.log("[Coverage] geoHeatmap:",{available:a.available,hasData:a.hasData,error:a.error,pointsCount:a?.data?.points?.length||0});const r=[...t.demandHeatmap||[],...t.coverageGaps||[]],d=new Set(r.map(e=>e.state).filter(Boolean)),l=s.length||d.size||0;document.getElementById("cov-suppliers").textContent=e.scraping?.suppliersTotal||"--",document.getElementById("cov-states").textContent=l||"--",document.getElementById("cov-active-zips").textContent=o.totalZips||(a.error?"Error":"--"),document.getElementById("cov-gaps").textContent=t.coverageGaps?.length||e.coverage?.trueCoverageGaps||"--",a.error&&console.error("[Coverage] GeoHeatmap error:",a.error);const c=document.getElementById("state-breakdown-body");c&&(c.innerHTML="",0===s.length?c.innerHTML='<tr><td colspan="4" class="no-data">No state data</td></tr>':s.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n            <td><strong>${e.state}</strong></td>\n            <td>${e.zips}</td>\n            <td>${(e.searches||0).toLocaleString()}</td>\n            <td>${(e.engagements||0).toLocaleString()}</td>\n          `,c.appendChild(t)}));const p=document.getElementById("top-locations-body");p&&(p.innerHTML="",0===i.length?p.innerHTML='<tr><td colspan="3" class="no-data">No location data</td></tr>':i.slice(0,15).forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n            <td>${e.city||"--"}, ${e.state||"--"}</td>\n            <td>${e.zip}</td>\n            <td>${(e.intensity||0).toLocaleString()}</td>\n          `,p.appendChild(t)}));const u=document.getElementById("coverage-gaps-body");u.innerHTML="";const m=t.coverageGaps||[];0===m.length?u.innerHTML='<tr><td colspan="4" class="no-data">No coverage gaps detected</td></tr>':m.slice(0,20).forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n          <td>${e.zip}</td>\n          <td>${e.city||"--"}, ${e.state||"--"}</td>\n          <td>${e.count}</td>\n          <td><button class="btn-small" onclick="showTab('settings')">Add Supplier</button></td>\n        `,u.appendChild(t)}),setupMapViewToggle(),loadCoverageMapWithView(currentMapView)}catch(e){console.error("Failed to load coverage:",e)}}function setupMapViewToggle(){document.querySelectorAll(".map-toggle-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".map-toggle-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),currentMapView=e.dataset.view,loadCoverageMapWithView(currentMapView)})})}function loadCoverageMapWithView(e){const{geographic:t,geoHeatmap:n,overview:a}=coverageData;map||(map=L.map("map-container").setView([40.7,-74],7),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(map)),map.eachLayer(e=>{e instanceof L.CircleMarker&&map.removeLayer(e)});const o=document.getElementById("map-stats");if("engagement"===e&&n?.points){const e=n.points||[],t=Math.max(...e.map(e=>e.intensity),1);if(o.innerHTML='<span style="color: #22c55e">‚óè</span> Low &nbsp; <span style="color: #f59e0b">‚óè</span> Medium &nbsp; <span style="color: #ef4444">‚óè</span> High Engagement',e.forEach(e=>{const n=e.intensity/t,a=6+18*n,o=n>.7?"#ef4444":n>.4?"#f59e0b":"#22c55e";L.circleMarker([e.lat,e.lng],{radius:a,fillColor:o,color:"#fff",weight:1,fillOpacity:.7}).bindPopup(`<b>${e.city||"--"}, ${e.state||"--"}</b><br>ZIP: ${e.zip}<br>Searches: ${e.searches}<br>Engagements: ${e.engagements}`).addTo(map)}),e.length>0){const t=L.latLngBounds(e.map(e=>[e.lat,e.lng]));map.fitBounds(t,{padding:[20,20]})}}else if("demand"===e&&t){const e=t.demandHeatmap||[],n=Math.max(...e.map(e=>e.count),1);o.innerHTML='<span style="color: #2563eb">‚óè</span> User Searches',e.forEach(e=>{const t=6+e.count/n*18;L.circleMarker([e.lat,e.lng],{radius:t,fillColor:"#2563eb",color:"#1d4ed8",weight:1,fillOpacity:.5}).bindPopup(`<b>${e.city||"--"}, ${e.state||""}</b><br>ZIP: ${e.zip}<br>Searches: ${e.count}`).addTo(map)})}else if("gaps"===e&&t){const e=t.coverageGaps||[],n=t.limitedCoverage||[],a=e.filter(e=>e.lat&&e.lng),s=n.filter(e=>e.lat&&e.lng),i=e.length-a.length,r=n.length-s.length,d=i>0?`${a.length} of ${e.length} ZIPs`:`${e.length} ZIPs`,l=r>0?`${s.length} of ${n.length} ZIPs`:`${n.length} ZIPs`;o.innerHTML=`<span style="color: #ef4444">‚óè</span> Coverage Gaps (${d}) &nbsp; <span style="color: #eab308">‚óè</span> Limited Coverage (${l})`,s.forEach(e=>{L.circleMarker([e.lat,e.lng],{radius:9,fillColor:"#eab308",color:"#ca8a04",weight:2,fillOpacity:.7}).bindPopup(`<b>‚ö†Ô∏è LIMITED COVERAGE</b><br>${e.city||"--"}, ${e.state||""}<br>ZIP: ${e.zip}<br>Searches: ${e.count}<br>Suppliers: ${e.supplierCount||"1-2"}`).addTo(map)}),a.forEach(e=>{L.circleMarker([e.lat,e.lng],{radius:10,fillColor:"#ef4444",color:"#dc2626",weight:2,fillOpacity:.7}).bindPopup(`<b>üö´ NO COVERAGE</b><br>${e.city||"--"}, ${e.state||""}<br>ZIP: ${e.zip}<br>Searches: ${e.count}<br>Suppliers: 0`).addTo(map)});const c=[...a,...s];if(c.length>0){const e=L.latLngBounds(c.map(e=>[e.lat,e.lng]));map.fitBounds(e,{padding:[30,30]})}}else"suppliers"===e&&(o.innerHTML='<span style="color: #22c55e">‚óè</span> Has Price &nbsp; <span style="color: #f59e0b">‚óè</span> No Price &nbsp; <span style="color: #9ca3af">‚óè</span> Inactive',api("/suppliers/map").then(e=>{if(!e.suppliers||0===e.suppliers.length)return void(o.innerHTML+=" &nbsp; (No geocoded suppliers yet)");e.suppliers.forEach(e=>{const t=e.active?e.price?"#22c55e":"#f59e0b":"#9ca3af",n=L.circleMarker([e.lat,e.lng],{radius:8,fillColor:t,color:"#fff",weight:2,opacity:1,fillOpacity:.8}),a=e.price?`$${e.price.toFixed(2)}/gal`:"No price";n.bindPopup(`\n          <strong>${e.name}</strong><br>\n          ${e.city}, ${e.state}<br>\n          ${a}\n        `),n.addTo(map)});const t=e.suppliers.filter(e=>e.lat&&e.lng);if(t.length>0){const e=L.latLngBounds(t.map(e=>[e.lat,e.lng]));map.fitBounds(e,{padding:[30,30]})}o.innerHTML=`<span style="color: #22c55e">‚óè</span> Has Price &nbsp; <span style="color: #f59e0b">‚óè</span> No Price &nbsp; <span style="color: #9ca3af">‚óè</span> Inactive &nbsp; (${e.mapped} suppliers mapped)`}).catch(e=>{console.error("Failed to load supplier locations:",e),o.innerHTML+=" &nbsp; (Error loading suppliers)"}))}async function loadSettings(){try{const e=await api("/scraper-health");document.getElementById("health-last-scrape").textContent=timeAgo(e.lastRun),document.getElementById("health-prices").textContent=`${e.withPrices}/${e.totalSuppliers}`,document.getElementById("health-stale").textContent=e.stale?.length||0}catch(e){console.error("Failed to load settings:",e)}}async function loadDashboard(){await Promise.all([loadOverview(),loadLeaderboard(),loadSupplierSignals(),loadConversion(),loadPriceAlerts()])}authToken?api("/meta").then(()=>showDashboard()).catch(()=>showLogin()):showLogin(),initActivityControls();